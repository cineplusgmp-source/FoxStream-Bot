<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Fox Stream Bot</title>
  <style>
    :root{
      --bg:#eef2f7; --card:#fff; --primary:#2563eb;
      --ok:#16a34a; --muted:#6b7280; --bubble:#e9f2ff;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Roboto,Arial;color:#0f172a}
    .wrap{max-width:980px;margin:auto;padding:24px}
    h1{text-align:center;margin:0}
    .sub,.ver{color:var(--muted);text-align:center}
    .ver{font-size:12px;margin:2px 0 14px}
    .card{background:#fff;border-radius:24px;box-shadow:var(--shadow);padding:20px 20px 16px;min-height:60vh}
    .chat{border:1px solid #e6ecf5;border-radius:20px;padding:14px;min-height:48vh;background:#fff;overflow:auto}
    .row{display:flex;gap:10px;margin:10px 0}
    .bot{max-width:78%}
    .me{margin-left:auto;max-width:78%}
    .bubble{background:var(--bubble);padding:10px 12px;border-radius:14px;line-height:1.45}
    .me .bubble{background:#eef2f7}
    .pill{display:inline-block;background:#eef5ff;padding:6px 10px;border-radius:999px}
    .actions{background:#f4f8ff;border:1px dashed #cfe0ff;padding:14px;border-radius:14px}
    .btn{display:inline-block;border:1px solid #cfe0ff;background:#fff;padding:10px 12px;border-radius:14px;cursor:pointer;user-select:none;margin:6px 8px 0 0}
    .bar{display:flex;gap:10px;margin-top:12px}
    .input{flex:1;border:1px solid #d9e2ef;padding:12px 14px;border-radius:14px;outline:none;font-size:16px;background:#fff}
    .send{border:none;background:var(--primary);color:#fff;padding:12px 18px;border-radius:14px;cursor:pointer;font-weight:600}
    .tip{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fox Stream Bot</h1>
    <div class="sub">Soporte autom√°tico 24/7</div>
    <div class="ver" id="versions">frontend v0.8 ¬∑ backend‚Ä¶</div>

    <div class="card">
      <div id="chat" class="chat"></div>

      <div class="bar">
        <input id="msg" class="input" placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)' />
        <button id="send" class="send">Enviar</button>
      </div>
      <div class="tip">Tip: presiona Enter para enviar.</div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const FRONT_VER = "0.8";
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";
    const API_BASE =
      "https://script.google.com/macros/s/AKfycbzPn0AeY6bKK5onUhfXeiWbSK_Pu3kNK-JI1qozE_OdxP4hAvo2_Jvmbv_lmRTvaarE/exec";

    // ======= Estado =======
    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const btn = document.getElementById("send");
    const versions = document.getElementById("versions");

    let state = "awaitPhone";     // awaitPhone -> menu -> awaitEmail
    let selectedType = null;      // 1,2,3
    let customers = [];

    // ======= UI =======
    const escapeHTML = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    const addBot = (html, cls="") => { const r=document.createElement("div"); r.className="row bot"; r.innerHTML=`<div class="bubble ${cls}">${html}</div>`; chat.appendChild(r); chat.scrollTop=chat.scrollHeight; };
    const addUser = (text) => { const r=document.createElement("div"); r.className="row me"; r.innerHTML=`<div class="bubble">${escapeHTML(text)}</div>`; chat.appendChild(r); chat.scrollTop=chat.scrollHeight; };

    function addActions(){
      const box = document.createElement("div");
      box.className = "row bot";
      box.innerHTML = `
        <div class="bubble actions">
          <div style="margin-bottom:8px;"><b>Selecciona una opci√≥n:</b></div>
          <div>
            <span class="btn" data-type="1">1) C√≥digo de acceso temporal</span>
            <span class="btn" data-type="2">2) Actualizar tu Hogar</span>
            <span class="btn" data-type="3">3) Nueva solicitud de inicio (TV)</span>
          </div>
        </div>`;
      chat.appendChild(box); chat.scrollTop = chat.scrollHeight;
      box.querySelectorAll(".btn").forEach(b => b.addEventListener("click", () => handleUserInput(b.dataset.type)));
    }

    // ======= Clientes CSV =======
    async function loadCustomers(){
      const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
      const csv = await res.text();
      const lines = csv.split(/\r?\n/).filter(Boolean);
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(",");
        if (cols.length<2) continue;
        out.push({ name: cols[0].trim(), phoneDigits: cols[1].replace(/\D/g,"") });
      }
      customers = out;
    }
    function existsPhone(userDigits){
      const last9 = userDigits.replace(/\D/g,"").slice(-9);
      return customers.some(c => c.phoneDigits.endsWith(last9));
    }

    // ======= Flujo =======
    function resetToStart(){
      state = "awaitPhone";
      selectedType = null;
      input.value = "";
      input.placeholder = 'Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)';
    }
    function toMenu(){
      state = "menu";
      addBot(`<span class="pill" style="background:#e9f9ee;color:#0f7a33">N√∫mero verificado. ¬°Bienvenido!</span>`);
      addActions();
      input.value = "";
      input.placeholder = 'Escribe "hola" para reiniciar o elige una opci√≥n';
    }
    function askEmailFor(type){
      selectedType = type;
      state = "awaitEmail";
      addBot(`Por favor, ingresa tu correo sin espacios:`);
      input.value = "";
      input.placeholder = "tu_correo@ejemplo.com";
    }

    async function consultInbox(type, email){
      addBot(`‚åõ Consultando tu correo‚Ä¶`, "pill");
      try{
        const url = `${API_BASE}?type=${encodeURIComponent(type)}&email=${encodeURIComponent(email)}&v=${encodeURIComponent(FRONT_VER)}`;
        const res = await fetch(url, { method:"GET", cache:"no-store" });
        const data = await res.json();

        if(!data.ok){
          const msg = data.message || "No se encontr√≥ ning√∫n correo enviado. Verifique que haya enviado el c√≥digo o el enlace. Vuelva a intentarlo una vez lo haya hecho.";
          addBot(`Error: ${escapeHTML(msg)}`, "pill");
          addBot(`Escribe <b>"hola"</b> para volver al men√∫ principal.`, "pill");
          resetToStart(); return;
        }

        if (type==="1" && data.code){
          addBot(`<b>Tu c√≥digo es:</b> <span class="pill">${escapeHTML(data.code)}</span><br/>Tienes 15 minutos para ingresarlo.`);
        } else if ((type==="2"||type==="3") && data.link){
          const link = escapeHTML(data.link);
          addBot(`<b>Tu enlace es:</b> <a href="${link}" target="_blank">${link}</a><br/>Tienes 15 minutos para ingresarlo.`);
        } else {
          addBot(`No se encontraron datos v√°lidos en el correo.`, "pill");
        }
        addBot(`Escribe <b>"hola"</b> para volver al men√∫ principal.`, "pill");
        resetToStart();
      }catch(err){
        addBot(`Error: ${escapeHTML(err.message||String(err))}`, "pill");
        addBot(`Escribe <b>"hola"</b> para volver al men√∫ principal.`, "pill");
        resetToStart();
      }
    }

    async function handleUserInput(raw){
      const text = (raw ?? input.value).trim();
      if (!text) return;
      addUser(text);
      input.value = "";

      if (text.toLowerCase() === "hola"){
        resetToStart();
        addBot(`üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.`);
        return;
      }

      if (state === "awaitPhone"){
        const digits = text.replace(/\D/g,"");
        if(!/^\d{6,15}$/.test(digits)){ addBot(`Formato inv√°lido. Escribe solo d√≠gitos.`); return; }
        if(!existsPhone(digits)){
          addBot(`‚ùå Tu n√∫mero no est√° registrado. Por favor, cont√°ctate con el administrador.`);
          addBot(`Escribe <b>"hola"</b> para volver al men√∫ principal.`, "pill");
          return;
        }
        toMenu(); return;
      }

      if (state === "menu"){
        const pick = text.replace(/[^\d]/g,"");
        if (["1","2","3"].includes(pick)) { askEmailFor(pick); return; }
        addBot(`Respuesta inv√°lida. Elige 1, 2 o 3.`); return;
      }

      if (state === "awaitEmail"){
        const email = text.toLowerCase();
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ addBot(`Correo inv√°lido.`); return; }
        await consultInbox(selectedType, email); return;
      }
    }

    btn.addEventListener("click", ()=>handleUserInput());
    input.addEventListener("keydown", e => { if(e.key==="Enter"){ e.preventDefault(); handleUserInput(); } });

    (async ()=>{
      // Mostrar versi√≥n de backend
      try{
        const r = await fetch(`${API_BASE}?ping=1&x=${Date.now()}`, {cache:"no-store"});
        const d = await r.json();
        versions.textContent = `frontend v${FRONT_VER} ¬∑ backend ${d.ok ? "v"+d.version : "(sin respuesta)"}`;
      }catch{ versions.textContent = `frontend v${FRONT_VER} ¬∑ backend (sin respuesta)`; }

      await loadCustomers();
      addBot(`üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.`);
    })();
  </script>
</body>
</html>
