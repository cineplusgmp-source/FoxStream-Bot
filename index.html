<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fox Stream Bot</title>
  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --accent:#1a73e8;
      --accent-weak:#e8f0fe;
      --text:#1f2937;
      --muted:#6b7280;
      --success:#16a34a;
      --bubble:#e9f2ff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:980px;
      margin:24px auto;
      padding:0 16px;
    }
    .card{
      background:var(--card);
      border-radius:24px;
      box-shadow:0 10px 30px rgba(16,24,40,.06);
      padding:20px;
    }
    h1{
      text-align:center;
      margin:6px 0 2px;
      font-size:34px;
      letter-spacing:.2px;
    }
    .subtitle{
      text-align:center;
      color:var(--muted);
      margin-bottom:18px;
    }
    .board{
      border:1px solid #e5e7eb;
      border-radius:20px;
      padding:14px;
      min-height:280px;        /* m√°s compacta que antes */
      background:#fff;
      overflow-y:auto;
      scroll-behavior:smooth;
    }
    .row{display:flex;gap:8px;align-items:flex-start;margin:10px 0}
    .msg{
      background:var(--bubble);
      padding:10px 12px;
      border-radius:12px;
      line-height:1.45;
      max-width:780px;
      font-size:15px;
    }
    .chip{
      background:#edf2ff;
      color:#334155;
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      margin-left:8px;
      white-space:nowrap;
    }
    .ok{background:#e8f8ed;color:#065f46}
    .error{background:#fde8e8;color:#b91c1c}
    .bot{align-items:center}
    .hint{color:var(--muted);font-size:14px}
    .options{
      background:var(--accent-weak);
      border:1px dashed #c6d4ff;
      border-radius:16px;
      padding:14px;
      margin:8px 0 4px;
    }
    .opt-title{font-weight:600;margin-bottom:8px}
    .opt-row{display:flex;gap:12px;flex-wrap:wrap}
    .option-btn{
      appearance:none;
      border:1px solid #c7d2fe;
      background:#fff;
      color:#1f2937;             /* texto visible */
      border-radius:12px;
      padding:10px 14px;
      font-size:14px;
      cursor:pointer;
      transition:transform .04s ease, box-shadow .15s ease;
      box-shadow:0 1px 0 rgba(0,0,0,.04);
    }
    .option-btn:hover{box-shadow:0 3px 10px rgba(26,115,232,.15)}
    .option-btn:active{transform:translateY(1px)}
    .footer{
      display:flex; gap:10px; margin-top:12px;
    }
    input[type="text"]{
      flex:1;
      padding:12px 14px;
      border:1px solid #d1d5db;
      border-radius:12px;
      font-size:15px;
      outline:none;
    }
    input[type="text"]::placeholder{color:#9ca3af}
    button.send{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:12px 18px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
    }
    .small{font-size:13px;color:var(--muted);margin-top:6px}
    @media (max-width:600px){
      .board{min-height:420px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fox Stream Bot</h1>
    <div class="subtitle">Soporte autom√°tico 24/7</div>

    <div class="card">
      <div id="board" class="board"></div>

      <div class="footer">
        <input id="input" type="text" placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)' />
        <button id="send" class="send">Enviar</button>
      </div>
      <div id="small" class="small">Tip: presiona Enter para enviar.</div>
    </div>
  </div>

  <script>
    /* ==================== CONFIG ==================== */
    // 1) Tu hoja publicada como CSV (la que me pasaste)
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";

    // 2) Tu API de Apps Script (endpoint /exec)
    const API_URL =
      "https://script.google.com/macros/s/AKfycbzPn0AeY6bKK5onUhfXeiWbSK_Pu3kNK-JI1qozE_OdxP4hAvo2_Jvmbv_lmRTvaarE/exec";

    // 3) Normalizaci√≥n de pa√≠s
    // N√∫meros en Sheet parecen traer prefijo de pa√≠s. Ajusta a tu realidad:
    const COUNTRY_CODE = "51";   // Per√∫ (c√°mbialo si corresponde)
    const LOCAL_DIGITS = 9;      // d√≠gitos que el cliente suele escribir (sin prefijo)

    /* ==================== ESTADO ==================== */
    const board = document.getElementById("board");
    const input = document.getElementById("input");
    const btn = document.getElementById("send");
    const small = document.getElementById("small");

    let customers = [];   // [{name, phoneRaw, phoneDigits}]
    let verified = false; // ya pas√≥ validaci√≥n
    let step = "welcome"; // welcome -> waitingPhone -> menu -> waitingEmailType1|2|3
    let chosenType = null; // 1,2,3
    let currentPhone = ""; // normalizado del cliente

    /* ==================== UI HELPERS ==================== */
    function addBot(text, cls=""){
      const row = document.createElement("div");
      row.className = "row bot";
      const bubble = document.createElement("div");
      bubble.className = "msg " + cls;
      bubble.innerHTML = text;
      row.appendChild(bubble);
      board.appendChild(row);
      board.scrollTop = board.scrollHeight;
    }
    function addUser(text){
      const row = document.createElement("div");
      row.className = "row";
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.style.background = "#eef2ff";
      bubble.style.marginLeft = "auto";
      bubble.innerText = text;
      row.appendChild(bubble);
      board.appendChild(row);
      board.scrollTop = board.scrollHeight;
    }
    function addOptions(){
      const box = document.createElement("div");
      box.className = "options";
      const title = document.createElement("div");
      title.className = "opt-title";
      title.innerText = "Selecciona una opci√≥n:";
      const row = document.createElement("div");
      row.className = "opt-row";

      const b1 = document.createElement("button");
      b1.className = "option-btn";
      b1.innerText = "1) C√≥digo de acceso temporal";
      b1.onclick = () => selectOption(1);

      const b2 = document.createElement("button");
      b2.className = "option-btn";
      b2.innerText = "2) Actualizar tu Hogar";
      b2.onclick = () => selectOption(2);

      const b3 = document.createElement("button");
      b3.className = "option-btn";
      b3.innerText = "3) Nueva solicitud de inicio (TV)";
      b3.onclick = () => selectOption(3);

      row.appendChild(b1); row.appendChild(b2); row.appendChild(b3);
      box.appendChild(title); box.appendChild(row);

      const wrap = document.createElement("div");
      wrap.className="row bot";
      wrap.appendChild(box);
      board.appendChild(wrap);
      board.scrollTop = board.scrollHeight;
    }

    function setPlaceholder(t){ input.placeholder = t; }

    function resetToWelcome(){
      verified = false;
      chosenType = null;
      currentPhone = "";
      step = "welcome";
      board.innerHTML = "";
      addBot("üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.");
      setPlaceholder('Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)');
    }

    /* ==================== SHEET & MATCH ==================== */
    function digitsOnly(s){ return (s||"").replace(/\D+/g,""); }

    function lastLocalDigits(phoneRaw){
      const d = digitsOnly(phoneRaw);
      if (d.length >= LOCAL_DIGITS) return d.slice(-LOCAL_DIGITS);
      return d;
    }

    async function loadSheet(){
      const res = await fetch(SHEET_CSV_URL, { cache:"no-store" });
      const csv = await res.text();

      // Parse s√∫per simple
      const rows = csv.trim().split(/\r?\n/);
      // Esperamos encabezados A: Nombre, B: Tel√©fono
      customers = [];
      for (let i=1;i<rows.length;i++){
        const parts = rows[i].split(",");
        // soporta nombres con coma entrecomillados
        if (parts.length >= 2){
          const name = rows[i].match(/^"(.*)"/) ? rows[i].match(/^"(.*)"/)[1] : parts[0];
          const phone = parts[parts.length-1];
          customers.push({
            name: (name || "").trim(),
            phoneRaw: phone.trim(),
            phoneDigits: lastLocalDigits(phone)
          });
        }
      }
    }

    function findByLocal(lastDigits){
      lastDigits = digitsOnly(lastDigits);
      return customers.find(c => c.phoneDigits === lastDigits) || null;
    }

    /* ==================== APP SCRIPT CALL ==================== */
    async function askApi(type, email){
      const url = `${API_URL}?type=${encodeURIComponent(type)}&email=${encodeURIComponent(email)}`;
      const res = await fetch(url, { method:"GET" });
      // Puede venir texto plano o JSON, intentamos JSON
      let data;
      try { data = await res.json(); }
      catch { 
        const t = await res.text();
        throw new Error("Respuesta no v√°lida del servidor: " + t);
      }
      if (!data || data.ok === false){
        throw new Error(data?.message || "No se pudo obtener datos del correo.");
      }
      return data; // {ok, message, code?, link?, receivedAt?}
    }

    /* ==================== L√ìGICA ==================== */
    function selectOption(n){
      chosenType = n;
      addUser(String(n));
      addBot("Por favor, ingresa tu correo sin espacios:");
      step = `waitingEmailType${n}`;
      setPlaceholder('Escribe tu correo‚Ä¶');
    }

    async function handleSubmit(){
      const value = input.value.trim();
      if (!value) return;

      // Atajo para "hola" -> volver al men√∫ principal
      if (value.toLowerCase() === "hola"){
        addUser("hola");
        resetToWelcome();
        input.value = "";
        return;
      }

      // Flujo por pasos
      if (step === "welcome" || step === "waitingPhone"){
        // Usuario escribe su n√∫mero
        addUser(value);
        const only = digitsOnly(value);
        if (!only){
          addBot("‚ö†Ô∏è Ingresa solo d√≠gitos, por favor.", "error");
          input.value = ""; return;
        }
        if (customers.length === 0){
          addBot("‚è≥ Cargando base de clientes‚Ä¶");
          await loadSheet();
        }
        const match = findByLocal(only);
        if (match){
          verified = true;
          currentPhone = only;
          addBot("‚úÖ N√∫mero verificado. ¬°Bienvenido!", "ok");
          addOptions();
          step = "menu";
          setPlaceholder('Escribe el n√∫mero de la opci√≥n o toca un bot√≥n');
        }else{
          addBot("‚ùå Tu n√∫mero no est√° registrado. Por favor, cont√°ctate con el administrador.", "error");
          addBot('Escribe <b>"hola"</b> para volver al men√∫ principal.');
        }
        input.value = "";
        return;
      }

      if (step.startsWith("waitingEmailType")){
        const email = value;
        addUser(email);
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
          addBot("‚ö†Ô∏è Ese correo no parece v√°lido. Intenta nuevamente.", "error");
          input.value = ""; return;
        }
        const t = chosenType || Number(step.slice(-1));
        try{
          addBot("‚è≥ Consultando tu correo‚Ä¶");
          const data = await askApi(t, email);

          if (t === 1){
            // C√≥digo 4 d√≠gitos
            const code = data.code || data.message || "(sin c√≥digo)";
            addBot(`Tu c√≥digo es: <b>${code}</b><br/>Tienes 15 minutos para ingresarlo.`);
          }else if (t === 2 || t === 3){
            const link = data.link || data.message || "(sin enlace)";
            addBot(`Tu enlace es: <a href="${link}" target="_blank" rel="noopener">${link}</a><br/>Tienes 15 minutos para ingresarlo.`);
          }else{
            addBot(data.message || "Listo.");
          }
        }catch(err){
          addBot("‚ùå " + err.message, "error");
        }
        addBot('Escribe <b>"hola"</b> para volver al men√∫ principal.');
        step = "done";
        setPlaceholder('Escribe "hola" para reiniciar');
        input.value = "";
        return;
      }

      if (step === "menu"){
        // Permitir que escriban 1/2/3 adem√°s de los botones
        if (["1","2","3"].includes(value)){
          selectOption(Number(value));
        }else{
          addUser(value);
          addBot('Responde con 1, 2 o 3, o toca un bot√≥n.');
        }
        input.value = "";
        return;
      }

      // done u otros
      addUser(value);
      addBot('Escribe <b>"hola"</b> para volver al men√∫ principal.');
      input.value = "";
    }

    // Enter & bot√≥n
    btn.addEventListener("click", handleSubmit);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") handleSubmit();
    });

    // Inicio
    resetToWelcome();
    // Precarga hoja en background sin bloquear
    loadSheet().catch(()=>{});
  </script>
</body>
</html>
