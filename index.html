<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fox Stream Bot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --ink:#0f172a;
      --muted:#64748b; --primary:#1d4ed8; --primary-ink:#fff;
      --chip:#e9f0ff; --chip-ink:#0f172a; --ok:#16a34a; --error:#dc2626;
      --bubble:#eaf1ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:980px;margin:24px auto;padding:12px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(2,6,23,.06);padding:18px}
    h1{margin:0 0 2px;font-size:clamp(26px,3.4vw,40px);text-align:center}
    .sub{margin:0 0 18px;text-align:center;color:var(--muted)}
    .chat{border:1px solid #e6e9f2;border-radius:14px;padding:14px;height:min(70vh,560px);overflow:auto;background:#fff}
    .row{display:flex;gap:10px;margin:10px 0;align-items:flex-start}
    .row .me{margin-left:auto}
    .bubble{background:var(--bubble);border-radius:12px;padding:10px 12px;display:inline-flex;align-items:center;gap:8px}
    .chip{background:#eef2ff;color:#334155;border-radius:999px;padding:6px 10px;font-weight:600}
    .ok{background:#ecfdf5;color:#065f46}
    .error{background:#fee2e2;color:#991b1b}
    .panel{background:#eff6ff;border:1px dashed #c7d7fe;border-radius:12px;padding:12px}
    .options{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .btn{background:#eef2ff;border:1px solid #c7d7fe;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(0.97)}
    .inputbar{display:flex;gap:10px;margin-top:12px}
    input[type="text"]{flex:1;padding:14px 12px;border-radius:10px;border:1px solid #d6d9e4}
    button.enviar{background:var(--primary);color:var(--primary-ink);border:none;border-radius:10px;padding:0 18px;font-weight:700}
    .hint{color:#8a94a7;font-size:12px;margin-top:6px}
    .tag{background:#eef2ff;border-radius:999px;padding:4px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fox Stream Bot</h1>
    <p class="sub">Soporte autom√°tico 24/7</p>

    <div class="card">
      <div id="chat" class="chat">
        <div class="row">
          <div class="bubble">üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.</div>
        </div>
      </div>

      <div class="inputbar">
        <input id="msg" type="text" placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)'>
        <button id="send" class="enviar">Enviar</button>
      </div>
      <div class="hint">Tip: presiona Enter para enviar.</div>
    </div>
  </div>

  <script>
  // ====== CONFIGURA TUS URLS ======
  // CSV publicado (Google Sheets ‚Üí Archivo > Compartir > Publicar en la web ‚Üí CSV de la Hoja 1)
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";

  // Apps Script WebApp (el URL que te dio ‚ÄúImplementar‚Äù ‚Üí App web ‚Üí URL)
  const GMAIL_API_URL =
    "https://script.google.com/macros/s/AKfycbzPn0AeY6bKK5onUhfXeiWbSK_Pu3kNK-JI1qozE_OdxP4hAvo2_Jvmbv_lmRTvaarE/exec";

  // ====== Estado del bot ======
  const chat = document.getElementById('chat');
  const input = document.getElementById('msg');
  const sendBtn = document.getElementById('send');

  let allowedNumbers = [];      // n√∫meros tal como vienen del CSV (solo d√≠gitos)
  let verified = false;         // ya pas√≥ validaci√≥n de tel√©fono
  let awaiting = null;          // 'option','number','email'
  let selectedOption = null;    // 1 | 2 | 3
  let tempNumberDigits = "";    // n√∫mero digitado por el usuario (solo d√≠gitos)

  function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }
  function addBubble(text, mine=false, cls=""){
    const row = document.createElement('div'); row.className='row';
    const b = document.createElement('div'); b.className='bubble '+cls; b.textContent=text;
    if(mine){ row.classList.add('me'); }
    row.appendChild(b); chat.appendChild(row); scrollToBottom();
  }
  function addPanelOptions(){
    const wrap = document.createElement('div'); wrap.className='row';
    const panel = document.createElement('div'); panel.className='panel';
    panel.innerHTML = `<div><strong>Selecciona una opci√≥n:</strong></div>`;
    const box = document.createElement('div'); box.className='options';
    [
      ["1) C√≥digo de acceso temporal",1],
      ["2) Actualizar tu Hogar",2],
      ["3) Nueva solicitud de inicio (TV)",3],
    ].forEach(([label,val])=>{
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent=label;
      btn.onclick=()=>{ processMessage(String(val)); };
      box.appendChild(btn);
    });
    panel.appendChild(box); wrap.appendChild(panel); chat.appendChild(wrap); scrollToBottom();
  }
  function addOk(text){ const r=document.createElement('div'); r.className='row'; const b=document.createElement('div'); b.className='bubble ok'; b.textContent=text; r.appendChild(b); chat.appendChild(r); scrollToBottom(); }
  function addErr(text){ const r=document.createElement('div'); r.className='row'; const b=document.createElement('div'); b.className='bubble error'; b.textContent=text; r.appendChild(b); chat.appendChild(r); scrollToBottom(); }
  function addTag(text){
    const row=document.createElement('div'); row.className='row me';
    const t=document.createElement('span'); t.className='tag'; t.textContent=text;
    row.appendChild(t); chat.appendChild(row); scrollToBottom();
  }

  // Normaliza: deja solo d√≠gitos
  const onlyDigits = s => (s||"").replace(/\D+/g,"");

  // Carga CSV sin cach√© y construye lista de n√∫meros de la columna "Tel√©fono"
  async function loadCSV(){
    const url = SHEET_CSV_URL + "&_=" + Date.now(); // no-cache
    const t = await fetch(url, {cache:"no-store"}).then(r=>r.text());
    const lines = t.split(/\r?\n/).filter(x=>x.trim()!=="");
    // detecta √≠ndice de la columna Tel√©fono por encabezado
    const header = lines[0].split(',');
    let phoneIdx = header.findIndex(h => /tel(e|√©)fono/i.test(h));
    if (phoneIdx < 0) phoneIdx = 1; // fallback columna B
    allowedNumbers = lines.slice(1).map(row=>{
      const cols = row.split(',');
      return onlyDigits(cols[phoneIdx] || "");
    }).filter(Boolean);
  }

  // La validaci√≥n ahora acepta que el usuario escriba SOLO los d√≠gitos finales.
  // Retorna true si alg√∫n n√∫mero registrado TERMINA con lo que escribi√≥ el usuario.
  function isAuthorized(userDigits){
    const q = onlyDigits(userDigits);
    if (!q) return false;
    // Requerimos al menos 6 d√≠gitos para reducir falsas coincidencias
    if (q.length < 6) return false;
    return allowedNumbers.some(reg => reg.endsWith(q));
  }

  function resetToStart(){
    verified = false; awaiting = null; selectedOption = null; tempNumberDigits="";
    addBubble('üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.');
  }

  async function queryGmailAPI(type, email){
    // Llama a tu Apps Script
    const url = `${GMAIL_API_URL}?type=${encodeURIComponent(type)}&email=${encodeURIComponent(email)}&_=${Date.now()}`;
    const res = await fetch(url, {mode:"cors", cache:"no-store"});
    return res.json();
  }

  async function processMessage(textRaw){
    let text = String(textRaw||"").trim();
    if (!text) return;

    // Mostrar lo que escribi√≥ el usuario como etiqueta
    addTag(text);

    // Comando 'hola' para reiniciar
    if (/^hola$/i.test(text)){
      addBubble('Escribe "hola" para volver al men√∫ principal.'); // recordatorio anterior
      resetToStart();
      return;
    }

    // Si a√∫n no est√° validado, esperamos un n√∫mero
    if (!verified){
      const digits = onlyDigits(text);
      tempNumberDigits = digits;
      if (!isAuthorized(digits)){
        addErr('Tu n√∫mero no est√° registrado. Por favor, cont√°ctate con el administrador.');
        addBubble('Escribe "hola" para volver al men√∫ principal.');
        return;
      }
      verified = true;
      addOk('N√∫mero verificado. ¬°Bienvenido!');
      awaiting = 'option';
      addPanelOptions();
      return;
    }

    // Elegir opci√≥n
    if (awaiting === 'option'){
      const opt = Number(onlyDigits(text));
      if (![1,2,3].includes(opt)){
        addErr('Opci√≥n inv√°lida. Responde 1, 2 o 3.');
        return;
      }
      selectedOption = opt;
      awaiting = 'email';
      addBubble('Por favor, ingresa tu correo sin espacios:');
      return;
    }

    // Capturar correo y consultar Gmail
    if (awaiting === 'email'){
      const email = text.toLowerCase();
      const okEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if (!okEmail){
        addErr('Correo inv√°lido. Intenta de nuevo.');
        return;
      }
      addBubble('‚è≥ Consultando tu correo‚Ä¶');

      try{
        const r = await queryGmailAPI(selectedOption, email);
        // r: { ok, message, code?, link?, receivedAt? }
        if (!r.ok){
          addErr(r.message || 'No encontramos informaci√≥n para ese correo.');
        }else{
          if (selectedOption === 1){
            addOk(`Tu c√≥digo es: ${r.code || '----'}`);
            addBubble('Tienes 15 minutos para ingresarlo.');
          }else if (selectedOption === 2){
            addOk(`Tu enlace es: ${r.link || '(no disponible)'}`);
            addBubble('Tienes 15 minutos para ingresarlo.');
          }else{
            addOk(`Tu enlace es: ${r.link || '(no disponible)'}`);
            addBubble('Tienes 15 minutos para ingresarlo.');
          }
        }
      }catch(e){
        addErr('Error consultando el correo. Verifica el URL de Apps Script.');
      }

      addBubble('Escribe "hola" para volver al men√∫ principal.');
      awaiting = null; selectedOption = null;
      return;
    }
  }

  // Listeners
  sendBtn.addEventListener('click', ()=>processMessage(input.value).then(()=>{input.value=""; input.focus();}));
  input.addEventListener('keydown', (e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); }});

  // Init
  (async ()=>{
    await loadCSV();
    // foco en el input
    input.focus();
  })();
  </script>
</body>
</html>
