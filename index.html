<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fox Stream Bot</title>
<style>
  :root{
    --bg:#f3f5f8;
    --card:#fff;
    --ink:#17212f;
    --muted:#6b7280;
    --brand:#2563eb;
    --bubble:#e8f0ff;
    --ok:#10b981;
    --err:#ef4444;
    --soft:#eff4ff;
    --chip:#e9eef9;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji",sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:8px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.04);padding:22px}
  h1{margin:0 0 6px 0;font-size:36px;font-weight:800;text-align:center}
  .sub{margin:0 0 14px 0;text-align:center;color:var(--muted)}
  .chat{border:1px solid #e6eaf3;border-radius:12px;padding:16px;min-height:380px;max-height:60vh;overflow:auto;background:#fff}
  .row{display:flex;margin:8px 0}
  .bot,.me{max-width:85%;padding:10px 12px;border-radius:12px;line-height:1.35;font-size:15px}
  .bot{background:#eaf1ff}
  .me{background:#f5f7fb;margin-left:auto}
  .status-ok{display:inline-block;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);color:#065f46;padding:8px 12px;border-radius:10px}
  .status-err{display:inline-block;background:rgba(239,68,68,.10);border:1px solid rgba(239,68,68,.35);color:#7f1d1d;padding:8px 12px;border-radius:10px}
  .panel{background:var(--soft);border:1px dashed #c7d3ff;padding:14px;border-radius:12px;margin:8px 0}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .chip{background:var(--chip);border-radius:10px;padding:10px 12px;cursor:pointer;border:1px solid #d6def0;user-select:none}
  .chip:hover{filter:brightness(.97)}
  .inputbar{display:flex;gap:10px;margin-top:10px}
  input[type=text]{flex:1;padding:14px;border-radius:10px;border:1px solid #d6deee;font-size:15px}
  button{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:12px 18px;font-size:15px;cursor:pointer}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  a.link{color:#0b57d0;word-break:break-all}
</style>
</head>
<body>
<div class="wrap">
  <h1>Fox Stream Bot</h1>
  <div class="sub">Soporte autom√°tico 24/7</div>

  <div class="card">
    <div id="chat" class="chat"></div>

    <div class="inputbar">
      <input id="msg" type="text" placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)' />
      <button id="send">Enviar</button>
    </div>
    <div class="hint">Tip: presiona Enter para enviar.</div>
  </div>
</div>

<script>
/* ==== CONFIG ==== */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";
const API_URL = "https://script.google.com/macros/s/AKfycbzPn0AeY6bKK5onUhfXeiWbSK_Pu3kNK-JI1qozE_OdxP4hAvo2_Jvmbv_lmRTvaarE/exec";

/* ==== Estado ==== */
const chat = document.getElementById("chat");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("send");

let phones = [];              // lista de tel√©fonos de la hoja
let stage = "ask_phone";      // ask_phone -> menu -> wait_email(type) -> done
let validatedPhone = null;

/* ==== Utilidades ==== */
const toDigits = s => String(s||"").replace(/\D+/g,"");
function endsMatch(inputDigits, phoneDigits){
  // coincide si el n√∫mero de la hoja termina en los d√≠gitos ingresados por el cliente
  return phoneDigits.endsWith(inputDigits);
}
function scrollDown(){ chat.scrollTop = chat.scrollHeight; }
function addBot(html){ const r = document.createElement("div"); r.className="row"; r.innerHTML=`<div class="bot">${html}</div>`; chat.appendChild(r); scrollDown(); }
function addMe(text){ const r = document.createElement("div"); r.className="row"; r.innerHTML=`<div class="me">${text}</div>`; chat.appendChild(r); scrollDown(); }
function addPanel(html){ const r = document.createElement("div"); r.className="panel"; r.innerHTML=html; chat.appendChild(r); scrollDown(); }
function resetToHello(){
  stage = "ask_phone";
  validatedPhone = null;
  input.value = "";
  chat.innerHTML = "";
  addBot("üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.");
}

async function loadPhones(){
  const res = await fetch(SHEET_CSV_URL);
  const text = await res.text();
  // Muy simple: columna B es ‚ÄúTel√©fono‚Äù
  phones = [];
  text.split(/\r?\n/).forEach((row,i)=>{
    const cols = row.split(",");
    if (i===0) return; // header
    const tel = toDigits(cols[1]||"");
    if (tel) phones.push(tel);
  });
}

function showMenu(){
  const ui = `
    <div><strong>Selecciona una opci√≥n:</strong></div>
    <div class="chips">
      <div class="chip" data-opt="1">1) C√≥digo de acceso temporal</div>
      <div class="chip" data-opt="2">2) Actualizar tu Hogar</div>
      <div class="chip" data-opt="3">3) Nueva solicitud de inicio (TV)</div>
    </div>
  `;
  addPanel(ui);
  document.querySelectorAll(".chip").forEach(el=>{
    el.addEventListener("click",()=> handleOption(el.getAttribute("data-opt")));
  });
}

function askEmailFor(type){
  stage = "wait_email_" + type;
  addBot("Por favor, ingresa tu correo sin espacios:");
}

async function queryApi(type, email){
  const url = `${API_URL}?type=${encodeURIComponent(type)}&email=${encodeURIComponent(email)}`;
  const res = await fetch(url, { method:"GET" });
  return await res.json();
}

function showBackToMenu(){
  addPanel('Escribe <strong>"hola"</strong> para volver al men√∫ principal.');
}

/* ==== Flujo ==== */
resetToHello();
loadPhones().catch(()=>{ /* si falla la hoja, igual dejamos seguir */ });

async function handleUserSend(){
  const text = input.value.trim();
  if (!text) return;

  addMe(text);

  // Reinicio r√°pido
  if (text.toLowerCase() === "hola"){
    resetToHello();
    return;
  }

  // Etapas
  if (stage === "ask_phone"){
    const only = toDigits(text);
    if (!only){ addBot(`<span class="status-err">Ingresa solo d√≠gitos.</span>`); return; }

    // validamos contra la hoja: coincide si cualquier tel√©fono termina con esos d√≠gitos
    const ok = phones.some(ph => endsMatch(only, ph));
    if (!ok){
      addBot(`<span class="status-err">Tu n√∫mero no est√° registrado. Por favor, cont√°ctate con el administrador.</span>`);
      showBackToMenu();
      return;
    }

    validatedPhone = only;
    addBot(`<span class="status-ok">N√∫mero verificado. ¬°Bienvenido!</span>`);
    stage = "menu";
    showMenu();
    input.placeholder = 'Escribe "hola" para reiniciar';
    return;
  }

  // Botones por n√∫mero (si el usuario teclea el n√∫mero directamente)
  if (stage === "menu"){
    const opt = text.replace(/\D+/g,"");
    if (["1","2","3"].includes(opt)){
      handleOption(opt);
    }else{
      addBot('Escribe 1, 2 o 3 para elegir una opci√≥n.');
    }
    return;
  }

  // Esperando correo:
  if (stage.startsWith("wait_email_")){
    const type = stage.split("_").pop();
    const email = text.trim().toLowerCase();
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
      addBot(`<span class="status-err">Correo inv√°lido. Intenta de nuevo.</span>`);
      return;
    }

    addBot("‚è≥ Consultando tu correo‚Ä¶");
    try{
      const data = await queryApi(type, email);
      if (data.ok){
        if (type==="1"){
          addBot(`Tu c√≥digo es: <strong>${data.code}</strong><br/>Tienes 15 minutos para ingresarlo.`);
        }else if (type==="2"){
          addBot(`Tu enlace es: <a class="link" href="${data.link}" target="_blank" rel="noopener">${data.link}</a><br/>Tienes 15 minutos para ingresarlo.`);
        }else{
          addBot(`Tu enlace es: <a class="link" href="${data.link}" target="_blank" rel="noopener">${data.link}</a><br/>Tienes 15 minutos para ingresarlo.`);
        }
      }else{
        // Mensaje claro cuando NO hay correo a√∫n
        addBot(`<span class="status-err">${data.message || "No fue posible obtener informaci√≥n."}</span>`);
      }
    }catch(e){
      addBot(`<span class="status-err">No se pudo consultar el servicio. Int√©ntalo nuevamente.</span>`);
    }
    showBackToMenu();
    stage = "done";
    return;
  }

  if (stage === "done"){
    addBot('Escribe <strong>"hola"</strong> para volver al men√∫ principal.');
  }
}

function handleOption(opt){
  addMe(opt);
  askEmailFor(opt);
}

sendBtn.addEventListener("click", handleUserSend);
input.addEventListener("keydown", (e)=>{ if (e.key==="Enter") handleUserSend(); });
</script>
</body>
</html>
