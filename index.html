<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fox Stream Bot</title>
  <style>
    :root{
      --bg:#eef2f7; --card:#fff; --primary:#2563eb; --primary-weak:#e8f0ff;
      --ok:#16a34a; --warn:#b91c1c; --muted:#6b7280; --bubble:#e9f2ff;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#0f172a;
    }
    .wrap{max-width:960px;margin:auto;padding:24px}
    .card{
      background:var(--card); border-radius:24px; box-shadow:var(--shadow);
      padding:20px 20px 16px; min-height:60vh;
    }
    h1{margin:0 0 4px; text-align:center; font-size:clamp(22px,3.2vw,40px);}
    .sub{color:var(--muted); text-align:center; margin-bottom:18px}
    .chat{border:1px solid #e6ecf5; border-radius:20px; padding:14px; min-height:48vh; background:#fff}
    .row{display:flex; gap:10px; margin:10px 0}
    .bot{max-width:70%}
    .me{margin-left:auto; max-width:70%}
    .bubble{
      background:var(--bubble); padding:10px 12px; border-radius:14px; line-height:1.45
    }
    .me .bubble{background:#eef2f7}
    .pill{display:inline-block;background:#eef2ff;padding:6px 10px;border-radius:999px}
    .ok{background:#e9f9ee;color:#0f7a33}
    .err{background:#fdecec;color:#b42318}
    .actions{background:#f4f8ff; border:1px dashed #cfe0ff; padding:14px; border-radius:14px}
    .btn{
      display:inline-block; border:1px solid #cfe0ff; background:#fff; padding:10px 12px;
      border-radius:12px; cursor:pointer; user-select:none; transition:.15s; margin:6px 8px 0 0
    }
    .btn:hover{background:#f7fbff}
    .bar{display:flex; gap:10px; margin-top:12px}
    .input{
      flex:1; border:1px solid #d9e2ef; padding:12px 14px; border-radius:14px; outline:none;
      font-size:16px; background:#fff;
    }
    .send{
      border:none; background:var(--primary); color:#fff; padding:12px 18px; border-radius:14px;
      cursor:pointer; font-weight:600;
    }
    .tip{color:var(--muted); font-size:12px}
    @media (max-width:640px){
      .chat{min-height:50vh}
      .bot,.me{max-width:85%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fox Stream Bot</h1>
    <div class="sub">Soporte autom√°tico 24/7</div>

    <div class="card">
      <div id="chat" class="chat"></div>

      <div class="bar">
        <input id="msg" class="input" placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)' />
        <button id="send" class="send">Enviar</button>
      </div>
      <div class="tip">Tip: presiona Enter para enviar.</div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    // 1) URL CSV P√öBLICO de Google Sheets (ya publicado como CSV)
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";

    // 2) URL del Web App (Apps Script) ‚Äî "Cualquiera" puede acceder
    //    (la URL que me pasaste)
    const API_URL =
      "https://script.google.com/macros/s/AKfycbzPn0AeY6bKK5onUhfXeiWbSK_Pu3kNK-JI1qozE_OdxP4hAvo2_Jvmbv_lmRTvaarE/exec";

    // 3) Pa√≠s por defecto (solo para normalizar n√∫meros). Ej.: 51 Per√∫, 52 M√©xico, etc.
    const DEFAULT_COUNTRY_CODE = "51"; // ajusta si lo necesitas

    // ========= Estado =========
    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const btn = document.getElementById("send");

    let state = "awaitPhone"; // awaitPhone -> menu -> awaitEmail
    let phoneOK = false;
    let selectedType = null; // 1,2,3
    let customers = [];      // [{name, phoneDigits}] normalizados (solo d√≠gitos)

    // ========= Utilidades UI =========
    const addBot = (html, cls="") => {
      const row = document.createElement("div"); row.className="row bot";
      row.innerHTML = `<div class="bubble ${cls}">${html}</div>`;
      chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
    };
    const addUser = (text) => {
      const row = document.createElement("div"); row.className="row me";
      row.innerHTML = `<div class="bubble">${escapeHTML(text)}</div>`;
      chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
    };
    const addActions = () => {
      const box = document.createElement("div");
      box.className = "row bot";
      box.innerHTML = `
        <div class="bubble actions">
          <div style="margin-bottom:8px;"><b>Selecciona una opci√≥n:</b></div>
          <div>
            <span class="btn" data-type="1">1) C√≥digo de acceso temporal</span>
            <span class="btn" data-type="2">2) Actualizar tu Hogar</span>
            <span class="btn" data-type="3">3) Nueva solicitud de inicio (TV)</span>
          </div>
        </div>`;
      chat.appendChild(box); chat.scrollTop = chat.scrollHeight;

      box.querySelectorAll(".btn").forEach(b=>{
        b.addEventListener("click", ()=>{
          const t = b.getAttribute("data-type");
          handleUserInput(t);
        });
      });
    };
    const escapeHTML = s => s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));

    // ========= CSV -> cargar clientes =========
    async function loadCustomers(){
      const res = await fetch(SHEET_CSV_URL);
      const csv = await res.text();
      const lines = csv.split(/\r?\n/).filter(Boolean);
      // Se espera: Col A = Nombre, Col B = Tel√©fono
      // Detecta encabezado y procesa
      const out = [];
      for (let i=1;i<lines.length;i++){
        const cols = lines[i].split(",");
        if (cols.length<2) continue;
        const name = cols[0].trim();
        const rawPhone = cols[1].trim();
        const onlyDigits = rawPhone.replace(/\D/g,"");
        out.push({ name, phoneDigits: onlyDigits });
      }
      customers = out;
    }

    function normalizePhone(inputDigits){
      // quita todo menos d√≠gitos
      let d = (inputDigits||"").toString().replace(/\D/g,"");
      // si el usuario no puso pa√≠s, intentamos machear por √∫ltimos 8‚Äì9‚Äì10 d√≠gitos
      // Estrategia: comparar por los √∫ltimos 9 d√≠gitos (aj√∫stalo a tu realidad)
      return d;
    }

    function existsPhone(userDigits){
      // comparamos por SUFIJO (√∫ltimos 9-10 d√≠gitos)
      const d = userDigits.replace(/\D/g,"");
      const last9 = d.slice(-9);
      return customers.some(c => c.phoneDigits.endsWith(last9));
    }

    // ========= Flujo =========
    function resetToStart(){
      state = "awaitPhone";
      selectedType = null;
      input.value = "";
      input.placeholder = 'Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)';
    }

    function toMenu(){
      state = "menu";
      addBot(`<span class="ok pill">N√∫mero verificado. ¬°Bienvenido!</span>`);
      addActions();
      input.value = "";
      input.placeholder = 'Escribe "hola" para reiniciar o elige una opci√≥n';
    }

    function askEmailFor(type){
      selectedType = type;
      state = "awaitEmail";
      addBot(`Por favor, ingresa tu correo sin espacios:`);
      input.value = "";
      input.placeholder = "tu_correo@ejemplo.com";
    }

    async function consultInbox(type, email){
      addBot(`‚åõ Consultando tu correo‚Ä¶`, "pill");
      try{
        const url = `${API_URL}?type=${encodeURIComponent(type)}&email=${encodeURIComponent(email)}`;
        const res = await fetch(url, { method:"GET" });
        const data = await res.json(); // <-- NO getResponseHeaders (no existe en fetch)

        if(!data.ok){
          const msg = data.message || "No se encontr√≥ ning√∫n correo enviado. Verifique que haya enviado el c√≥digo o el enlace. Vuelva a intentarlo una vez lo haya hecho.";
          addBot(`Error: ${escapeHTML(msg)}`, "err");
          addBot(`Escribe <b>"hola"</b> para volver al men√∫ principal.`, "pill");
          resetToStart(); return;
        }

        if (type==="1" && data.code){
          addBot(`<b>Tu c√≥digo es:</b> <span class="pill">${escapeHTML(data.code)}</span><br/>Tienes 15 minutos para ingresarlo.`);
        }else if ((type==="2"||type==="3") && data.link){
          addBot(`<b>Tu enlace es:</b> <a href="${escapeHTML(data.link)}" target="_blank">${escapeHTML(data.link)}</a><br/>Tienes 15 minutos para ingresarlo.`);
        }else{
          addBot(`No se encontraron datos v√°lidos en el correo.`, "err");
        }

        addBot(`Escribe <b>"hola"</b> para volver al men√∫ principal.`, "pill");
        resetToStart();
      }catch(err){
        addBot(`Error: ${escapeHTML(err.message||String(err))}`, "err");
        addBot(`Escribe <b>"hola"</b> para volver al men√∫ principal.`, "pill");
        resetToStart();
      }
    }

    async function handleUserInput(raw){
      const text = (raw ?? input.value).trim();
      if(!text) return;

      // mostrar mensaje del usuario
      addUser(text);

      if(state==="awaitPhone"){
        const digits = normalizePhone(text);
        if(!/^\d{6,15}$/.test(digits)){
          addBot(`Formato inv√°lido. Por favor, escribe solo d√≠gitos.`,"err");
          input.value=""; return;
        }
        const ok = existsPhone(digits);
        if(!ok){
          addBot(`‚ùå Tu n√∫mero no est√° registrado. Por favor, cont√°ctate con el administrador.`,"err");
          addBot(`Escribe <b>"hola"</b> para volver al men√∫ principal.`,"pill");
          input.value=""; return;
        }
        phoneOK = true; toMenu(); input.value="";
      }
      else if(state==="menu"){
        const t = text.toLowerCase();
        if (t==="hola"){ resetToStart(); addBot(`üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.`); return; }

        if (["1","2","3"].includes(t)){
          askEmailFor(t);
        }else{
          addBot(`Escribe 1, 2 o 3; o "hola" para reiniciar.`,"pill");
        }
        input.value="";
      }
      else if(state==="awaitEmail"){
        const email = text.toLowerCase();
        // validaci√≥n b√°sica
        if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
          addBot(`Correo inv√°lido. Intenta nuevamente.`,"err");
          input.value=""; return;
        }
        await consultInbox(selectedType, email);
        input.value="";
      }
    }

    // ========= Listeners =========
    btn.addEventListener("click", ()=>handleUserInput());
    input.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); handleUserInput(); }
    });

    // ========= Inicio =========
    (async ()=>{
      await loadCustomers();
      addBot(`üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.`);
    })();
  </script>
</body>
</html>
