<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fox Stream Bot</title>

  <!-- Bootstrap 5 (responsive, sin instalar nada) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{background:#f5f6fa}
    .app{max-width:720px;margin:24px auto;padding:12px}
    .chat{background:#fff;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .msg{display:flex;margin-bottom:12px}
    .msg .bubble{max-width:85%;padding:10px 12px;border-radius:14px;font-size:15px;line-height:1.35}
    .from-bot .bubble{background:#e9f5ff;border:1px solid #d5ecff}
    .from-user{justify-content:flex-end}
    .from-user .bubble{background:#e7ffe9;border:1px solid #c9f4cd}
    .composer{display:flex;gap:8px}
    .composer input{flex:1}
    .options button{margin:4px 6px 0 0}
    .brand{font-weight:700}
    @media (max-width:480px){
      .msg .bubble{max-width:92%}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="text-center mb-3">
      <h2 class="brand">Fox Stream Bot</h2>
      <div class="text-muted small">Soporte autom√°tico 24/7</div>
    </div>

    <div class="chat" id="chat">
      <!-- Mensajes se insertan aqu√≠ -->
    </div>

    <form class="composer mt-2" id="composer">
      <input id="input" class="form-control" placeholder="Escribe aqu√≠‚Ä¶ (ej: hola)" autocomplete="off">
      <button class="btn btn-primary" type="submit">Enviar</button>
    </form>
  </div>

  <script>
    // === Config ===
    // Paso 7 cambiaremos API_URL a tu endpoint en Vercel: "https://TU-PROYECTO.vercel.app/api/validate"
    const API_URL = ""; // si est√° vac√≠o, usar√° la lista local

    // Lista local para pruebas r√°pidas (ed√≠tala con tus clientes)
    const ALLOWED_NUMBERS = [
      "51995602221", "50232338393", "519803220026", "51910303715"
    ];

    // === Utilidades ===
    const chat = document.getElementById('chat');
    const composer = document.getElementById('composer');
    const input = document.getElementById('input');
    let state = "idle"; // idle ‚Üí ask_phone ‚Üí validated
    let validated = false;

    const normalize = s => (s||"").toString().replace(/\D/g,'');
    function addMsg(text, who="bot"){
      const wrap = document.createElement('div');
      wrap.className = `msg ${who==="bot"?"from-bot":"from-user"}`;
      wrap.innerHTML = `<div class="bubble">${text}</div>`;
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }

    async function validatePhoneLocalOrAPI(phoneRaw){
      const phone = normalize(phoneRaw);
      if(!phone) return {ok:false, message:"Indica un n√∫mero v√°lido."};

      // Si hay API_URL, consultar servidor
      if(API_URL){
        try{
          const res = await fetch(`${API_URL}?phone=${encodeURIComponent(phone)}`, {method:'GET'});
          const data = await res.json();
          return data;
        }catch(e){
          return {ok:false, message:"Error validando n√∫mero. Intenta de nuevo."};
        }
      }

      // Modo local (pruebas)
      const ok = ALLOWED_NUMBERS.some(aut => {
        const a = normalize(aut);
        return a && (a===phone || a.endsWith(phone) || phone.endsWith(a));
      });
      return ok
        ? {ok:true, message:"N√∫mero verificado. ¬°Bienvenido!"}
        : {ok:false, message:"Tu n√∫mero no est√° registrado. Contacta al administrador."};
    }

    function showOptions(){
      const box = document.createElement('div');
      box.className = 'options';
      box.innerHTML = `
        <div class="msg from-bot"><div class="bubble">
          Selecciona una opci√≥n:
          <div class="mt-2">
            <button class="btn btn-outline-primary btn-sm" data-opt="1">1) C√≥digo de acceso temporal</button>
            <button class="btn btn-outline-primary btn-sm" data-opt="2">2) Actualizar tu Hogar</button>
            <button class="btn btn-outline-primary btn-sm" data-opt="3">3) Nueva solicitud de inicio (TV)</button>
          </div>
        </div></div>
      `;
      box.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.preventDefault();
          const opt = btn.getAttribute('data-opt');
          handleOption(opt);
        });
      });
      chat.appendChild(box.firstElementChild);
      chat.scrollTop = chat.scrollHeight;
    }

    function handleOption(opt){
      if(!validated){ addMsg("Primero valida tu n√∫mero escribiendo: hola", "bot"); return; }
      addMsg(opt, "user");
      if(opt==="1"){
        addMsg("üìå C√≥digo de acceso temporal: <b>934231163</b>", "bot");
      }else if(opt==="2"){
        addMsg("üè† Para actualizar tu hogar: visita el men√∫ en tu TV y elige 'Actualizar Hogar'.", "bot");
      }else if(opt==="3"){
        addMsg("üì∫ Nueva solicitud de inicio: en la TV elige 'Enviar enlace de inicio de sesi√≥n'.", "bot");
      }else{
        addMsg("Opci√≥n no v√°lida.", "bot");
      }
    }

    // === Inicio del flujo ===
    addMsg("üëã ¬°Hola! Escribe <b>hola</b> para comenzar.", "bot");

    composer.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      addMsg(text, "user");
      input.value = "";

      if(state==="idle"){
        if(text.toLowerCase()==="hola"){
          state = "ask_phone";
          addMsg("Escribe tu n√∫mero de tel√©fono para validar acceso.", "bot");
        }else{
          addMsg("Para iniciar escribe: <b>hola</b>", "bot");
        }
        return;
      }

      if(state==="ask_phone"){
        const res = await validatePhoneLocalOrAPI(text);
        if(res.ok){
          validated = true;
          state = "validated";
          addMsg("‚úÖ " + (res.message || "N√∫mero verificado. ¬°Bienvenido!"), "bot");
          showOptions();
        }else{
          validated = false;
          addMsg("üö´ " + (res.message || "N√∫mero no autorizado."), "bot");
          addMsg("Si necesitas ayuda, contacta al administrador.", "bot");
          state = "idle";
        }
        return;
      }

      if(state==="validated"){
        // Cuando ya est√° validado, permitir atajos por texto: 1,2,3
        if(["1","2","3"].includes(text)) return handleOption(text);
        addMsg("Escribe 1, 2 o 3, o pulsa un bot√≥n.", "bot");
      }
    });
  </script>
</body>
</html>
