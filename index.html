<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fox Stream Bot</title>
  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --primary:#2563eb;
      --primary-600:#1d4ed8;
      --text:#0f172a;
      --muted:#64748b;
      --bubble:#eaf2ff;
      --success:#22c55e;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --radius:18px;
      --maxw:980px;
      --chatw:740px;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{
      max-width:var(--maxw);
      margin:32px auto;
      padding:0 16px;
    }
    h1{
      margin:4px 0 2px;
      text-align:center;
      font-size:clamp(22px,3vw,30px);
      letter-spacing:.2px;
    }
    .subtitle{
      text-align:center;
      color:var(--muted);
      margin-bottom:18px;
      font-size:14px;
    }
    .card{
      background:var(--card);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:18px;
      margin:0 auto;
      max-width:var(--chatw);
      display:flex;
      flex-direction:column;
      min-height:60vh;
    }
    .chat{
      flex:1;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:14px;
      overflow:auto;
      scroll-behavior:smooth;
    }
    .msg{
      max-width:min(88%,560px);
      background:var(--bubble);
      padding:10px 12px;
      border-radius:14px;
      margin:8px 0;
      box-shadow:0 1px 0 rgba(15,23,42,.03);
    }
    .msg small{color:var(--muted);display:block;margin-top:6px}
    .bot{align-self:flex-start}
    .user{align-self:flex-end;background:#eef2f7}
    .row{
      display:flex;gap:10px;align-items:center;margin-top:12px
    }
    input[type="text"]{
      flex:1;
      border:1px solid #dbe1ea;
      background:#fff;
      border-radius:12px;
      padding:12px 14px;
      font-size:16px;
      outline:none;
    }
    input[type="text"]::placeholder{color:#9aa8bb}
    button{
      background:var(--primary);
      color:#fff;border:0;border-radius:12px;
      padding:12px 18px;font-weight:600;cursor:pointer
    }
    button:hover{background:var(--primary-600)}
    .pill{
      display:inline-block; border:1px solid #cfe0ff;background:#f6f9ff;
      padding:8px 10px;border-radius:12px;margin:6px 6px 0 0;
      cursor:pointer; user-select:none;
    }
    .pill:hover{background:#eef5ff}
    .system{
      display:inline-flex;align-items:center;gap:8px;
      background:#eaf2ff;border:1px solid #d9e6ff;color:#0b3b8f;
    }
    .ok{color:var(--success)}
    .error{color:#b91c1c}
    .loading{opacity:.7}
    .footer{margin-top:10px;font-size:12px;color:var(--muted);text-align:center}
    @media (min-width:1024px){
      .card{min-height:70vh}
      .chat{padding:16px 18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fox Stream Bot</h1>
    <div class="subtitle">Soporte autom√°tico 24/7</div>

    <div class="card">
      <div id="chat" class="chat"></div>

      <div class="row">
        <input id="input" type="text" placeholder='Tu n√∫mero (solo d√≠gitos) o escribe "hola"' autocomplete="off" />
        <button id="send">Enviar</button>
      </div>
      <div class="footer">Escribe <b>hola</b> para reiniciar el flujo en cualquier momento.</div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    // CSV publicado de tu Google Sheet (Hoja1: Nombre | Tel√©fono)
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";

    // Pa√≠s por defecto para normalizar (si tus n√∫meros NO tienen prefijo)
    const DEFAULT_COUNTRY = ""; // ejemplo: "51" para Per√∫, "57" CO, "52" MX. D√©jalo "" si ya guardas con prefijo.

    // ========= ESTADO =========
    const state = {
      step: "askPhone",     // askPhone -> validated -> menu -> action
      phoneOk: false,
      phone: "",
      csvPhones: new Set(), // tel√©fonos normalizados desde el sheet
      csvMap: new Map()     // phone -> nombre (opcional)
    };

    // ========= UI HELPERS =========
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    function scrollBottom(){ chat.scrollTop = chat.scrollHeight; }

    function bubble(text, who="bot", extraClass=""){
      const div = document.createElement("div");
      div.className = `msg ${who} ${extraClass}`;
      div.innerHTML = text;
      chat.appendChild(div);
      scrollBottom();
      return div;
    }

    function sys(text){
      bubble(`üëã ${text}`,"bot","system");
    }

    function sanitizePhone(raw){
      if(!raw) return "";
      let s = String(raw).replace(/[^\d]/g,""); // quita todo menos d√≠gitos
      // si definiste DEFAULT_COUNTRY y el n√∫mero parece local (ej. 9-10 d√≠gitos) puedes decidir anteponer:
      if(DEFAULT_COUNTRY && (s.length===9 || s.length===10)){
        s = DEFAULT_COUNTRY + s;
      }
      return s;
    }

    // ========= CSV LOADER =========
    async function loadPhones(){
      try{
        const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
        const csv = await res.text();
        // Parse simple CSV (Nombre,Telefono)
        // Dividimos por l√≠neas; ignoramos encabezado (primera l√≠nea)
        const lines = csv.trim().split(/\r?\n/);
        lines.slice(1).forEach(line=>{
          // Cuidado con nombres que contengan coma; en tu sheet no se ve, as√≠ que split simple:
          const parts = line.split(",");
          if(parts.length>=2){
            const name = parts[0].trim();
            const phone = sanitizePhone(parts[1]);
            if(phone){
              state.csvPhones.add(phone);
              state.csvMap.set(phone, name || "");
            }
          }
        });
      }catch(e){
        bubble(`‚ö†Ô∏è <b>Error al leer la lista de clientes.</b> Intenta recargar la p√°gina.`, "bot", "error");
        console.error(e);
      }
    }

    // ========= FLUJOS =========
    function showMenu(){
      state.step = "menu";
      const menu = [
        ["1) C√≥digo de acceso temporal","code"],
        ["2) Actualizar tu Hogar","home"],
        ["3) Nueva solicitud de inicio (TV)","newtv"]
      ];
      const container = document.createElement("div");
      container.className = "msg bot";
      container.innerHTML = `<div><b>Selecciona una opci√≥n:</b></div>`;
      menu.forEach(([label,key])=>{
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = label;
        pill.onclick = ()=>handleMenu(key);
        container.appendChild(pill);
      });
      chat.appendChild(container);
      scrollBottom();
    }

    function endWithRestart(){
      bubble(`‚úÖ Listo. <br>Escribe <b>"hola"</b> para volver al men√∫ principal.`, "bot");
      state.step = "validated"; // ya est√° validado; si pone hola, lo llevamos al men√∫
      input.placeholder = 'Escribe "hola" para volver al men√∫';
    }

    async function handleMenu(key){
      state.step = "action";
      if(key==="code"){
        bubble("1) C√≥digo de acceso temporal", "user");
        // Aqu√≠ ir√≠a tu integraci√≥n real (API/Proveedores).
        await new Promise(r=>setTimeout(r,600));
        bubble("üîê Tu c√≥digo de acceso temporal es: <b>934231163</b> (demo).", "bot");
        endWithRestart();
      }else if(key==="home"){
        bubble("2) Actualizar tu Hogar", "user");
        await new Promise(r=>setTimeout(r,600));
        bubble("üè† Hogar actualizado correctamente (demo).", "bot");
        endWithRestart();
      }else if(key==="newtv"){
        bubble("3) Nueva solicitud de inicio (TV)", "user");
        await new Promise(r=>setTimeout(r,600));
        bubble("üì∫ Enviamos un enlace de inicio de sesi√≥n a tu TV (demo).", "bot");
        endWithRestart();
      }
    }

    function resetToAskPhone(){
      state.step = "askPhone";
      state.phoneOk = false;
      state.phone = "";
      input.value = "";
      input.placeholder = "Tu n√∫mero (solo d√≠gitos)";
      chat.innerHTML = ""; // limpiamos conversaci√≥n para que no quede un lienzo vac√≠o fijo
      sys("¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.");
    }

    function afterValidated(){
      const name = state.csvMap.get(state.phone) || "";
      bubble(`‚òëÔ∏è N√∫mero verificado ${name ? "para <b>"+name+"</b>": ""}. ¬°Bienvenido!`, "bot", "ok");
      showMenu();
    }

    // ========= HANDLER PRINCIPAL =========
    async function onUserSend(){
      const raw = input.value.trim();
      if(!raw) return;

      // mostrar lo que escribi√≥ el usuario
      bubble(raw, "user");
      input.value = "";

      // Comandos
      const lower = raw.toLowerCase();
      if(lower==="hola" || lower==="menu" || lower==="inicio"){
        if(state.phoneOk){
          // ya validado -> mostrar men√∫
          showMenu();
        }else{
          resetToAskPhone();
        }
        return;
      }

      if(state.step==="askPhone"){
        const phone = sanitizePhone(raw);
        if(!phone || phone.length < 7){
          bubble("‚ùå Ingresa un n√∫mero v√°lido (solo d√≠gitos).", "bot", "error");
          return;
        }
        state.phone = phone;
        // validaci√≥n con el set de tel√©fonos
        const checking = bubble("Verificando n√∫mero...", "bot", "loading");
        await new Promise(r=>setTimeout(r,250)); // micro delay para que se vea el estado
        checking.remove();

        if(state.csvPhones.has(phone)){
          state.phoneOk = true;
          state.step = "validated";
          afterValidated();
        }else{
          bubble("‚ùå Tu n√∫mero no est√° registrado. Por favor contacta al administrador.", "bot", "error");
          bubble('Cuando lo agreguen, escribe <b>"hola"</b> para intentarlo de nuevo.', "bot");
          state.step = "blocked";
          input.placeholder = 'Escribe "hola" para reintentar';
        }
        return;
      }

      if(state.step==="menu"){
        // permitir que el usuario escriba 1,2,3 en vez de pulsar los botones
        const map = { "1":"code", "2":"home", "3":"newtv" };
        if(map[lower]) return handleMenu(map[lower]);
        bubble('Elige 1, 2 o 3, o usa los botones azules.', "bot");
        return;
      }

      if(state.step==="action" || state.step==="validated"){
        bubble('Escribe <b>"hola"</b> para volver al men√∫ principal.', "bot");
      }
    }

    // ========= INIT =========
    (async function init(){
      sys("¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.");
      await loadPhones();
      input.focus();
    })();

    sendBtn.addEventListener("click", onUserSend);
    input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") onUserSend(); });
  </script>
</body>
</html>
