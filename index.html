<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fox Stream Bot</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --primary:#1a73e8;
    --bot:#e9f1ff;
    --text:#1f2937;
    --muted:#6b7280;
    --success:#0f9d58;
    --danger:#d93025;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    color:var(--text);
  }
  .wrap{
    max-width:920px;
    margin:24px auto;
    padding:16px;
  }
  .card{
    background:var(--card);
    border-radius:18px;
    box-shadow:0 6px 22px rgba(0,0,0,.06);
    padding:20px;
  }
  h1{
    text-align:center;
    margin:0 0 4px;
  }
  .subtitle{
    text-align:center;
    color:var(--muted);
    margin:0 0 16px;
    font-size:14px;
  }

  /* Chat area */
  .chat{
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:12px;
    min-height:260px;           /* suficiente para que no se vea ‚Äúvac√≠o‚Äù */
    max-height:60vh;            /* crece y luego hace scroll */
    overflow:auto;
  }
  .msg{
    display:inline-flex;
    align-items:flex-start;
    gap:.5rem;
    background:var(--bot);
    padding:10px 12px;
    border-radius:10px;
    margin:10px 0;
    width:fit-content;
    max-width:min(680px, 95%);
  }
  .msg.user{
    background:#eef2f7;
    margin-left:auto;
  }
  .msg p{margin:0}
  .msg small{color:var(--muted)}

  .inputbar{
    display:flex; gap:10px; margin-top:12px;
  }
  .inputbar input{
    flex:1;
    padding:12px 14px;
    border:1px solid #e5e7eb;
    border-radius:10px;
    font-size:15px;
  }
  .inputbar button{
    background:var(--primary);
    color:#fff;
    border:0;
    padding:0 18px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
  }
  .pill{
    display:inline-block;
    padding:8px 10px;
    border:1px solid #cfe1ff;
    background:#f4f9ff;
    border-radius:8px;
    margin:6px 6px 0 0;
    cursor:pointer;
  }
  .ok{color:var(--success);font-weight:600}
  .err{color:var(--danger);font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fox Stream Bot</h1>
      <p class="subtitle">Soporte autom√°tico 24/7</p>

      <div id="chat" class="chat"></div>

      <!-- IMPORTANTE: form para que ENTER funcione -->
      <form id="chatForm" class="inputbar" autocomplete="off">
        <input id="chatInput" type="text" placeholder='Tu n√∫mero (solo d√≠gitos) o escribe "hola"' />
        <button id="sendBtn" type="submit">Enviar</button>
      </form>
    </div>
  </div>

<script>
/* ===== Config ===== */
const SHEET_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";
const DEFAULT_COUNTRY = "51";       // anteponer si llega un m√≥vil de 9 d√≠gitos

/* ===== Estado ===== */
let allowedPhones = new Set();      // tel√©fonos normalizados
let phase = "awaiting_phone";       // awaiting_phone | menu
let currentPhone = null;

/* ===== Utilidades ===== */
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("chatInput");
const formEl  = document.getElementById("chatForm");
const sendBtn = document.getElementById("sendBtn");

function scrollToBottom(){ chatEl.scrollTop = chatEl.scrollHeight; }

function addMsg(html, who="bot"){
  const div = document.createElement("div");
  div.className = "msg" + (who==="user" ? " user" : "");
  div.innerHTML = html;
  chatEl.appendChild(div);
  scrollToBottom();
}

function normalizeNumber(raw){
  // quita todo lo que no sea d√≠gito
  let n = (raw || "").toString().replace(/\D+/g,"");
  // si parece un m√≥vil peruano de 9 d√≠gitos, anteponer 51
  if(n.length === 9) n = DEFAULT_COUNTRY + n;
  return n;
}

async function fetchPhones(){
  try{
    const res = await fetch(SHEET_CSV, {cache:"no-store"});
    const text = await res.text();
    // Parse muy sencillo: asume 2 primeras columnas (Nombre, Tel√©fono)
    const lines = text.replace(/^\uFEFF/,'').split(/\r?\n/);
    const set = new Set();
    for(let i=1;i<lines.length;i++){
      const row = lines[i].split(",");
      if(!row || row.length < 2) continue;
      const phone = normalizeNumber(row[1]);
      if(phone) set.add(phone);
    }
    allowedPhones = set;
  }catch(e){
    console.error("Error leyendo CSV:", e);
  }
}

function showWelcome(){
  addMsg("üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.");
}

function showMenu(){
  const html = `
    <p><strong>Selecciona una opci√≥n:</strong></p>
    <div>
      <span class="pill" data-opt="codigo">1) C√≥digo de acceso temporal</span>
      <span class="pill" data-opt="hogar">2) Actualizar tu Hogar</span>
      <span class="pill" data-opt="nueva">3) Nueva solicitud de inicio (TV)</span>
    </div>
  `;
  addMsg(html);
  // delegaci√≥n de eventos para las ‚Äúpills‚Äù
  chatEl.querySelectorAll('.pill').forEach(p => {
    p.addEventListener('click', () => handleMenu(p.dataset.opt));
  });
}

function endWithBackToMenu(){
  addMsg(`Escribe <strong>"hola"</strong> para volver al men√∫ principal.`);
  phase = "menu"; // sigue en men√∫ hasta que el usuario escriba hola de nuevo (refresca lista tambi√©n)
}

function handleMenu(opt){
  let rsp = "";
  if(opt === "codigo"){
    rsp = "üîê Aqu√≠ tienes tu <strong>c√≥digo temporal</strong>: <code>" +
          Math.floor(100000 + Math.random()*900000) + "</code> (v√°lido por 10 min).";
  }else if(opt === "hogar"){
    rsp = "üè† Para actualizar tu hogar env√≠anos el ID del dispositivo o comun√≠cate con soporte.";
  }else if(opt === "nueva"){
    rsp = "üì∫ Listo. Generaremos una nueva solicitud de inicio. Te avisaremos por WhatsApp cuando est√© activa.";
  }else{
    rsp = "No entend√≠ esa opci√≥n.";
  }
  addMsg(rsp);
  endWithBackToMenu();
}

/* ===== Flujo principal ===== */
async function processUserInput(raw){
  const text = (raw || "").trim();
  if(!text) return;

  addMsg(text.replace(/</g,"&lt;"), "user");   // eco seguro

  // Volver al men√∫
  if(/^hola$/i.test(text)){
    await fetchPhones();                       // refresca listado por si agregaste nuevos n√∫meros
    if(currentPhone){
      addMsg("üëã Hola de nuevo. Men√∫ principal:");
      showMenu();
      phase = "menu";
    }else{
      phase = "awaiting_phone";
      showWelcome();
    }
    return;
  }

  if(phase === "awaiting_phone"){
    // intentamos validar como n√∫mero
    const n = normalizeNumber(text);
    if(!n){
      addMsg('Por favor, escribe solo n√∫meros. Ej: <code>51987654321</code>.');
      return;
    }
    // validar
    if(allowedPhones.has(n)){
      currentPhone = n;
      addMsg('<span class="ok">‚úî N√∫mero verificado. ¬°Bienvenido!</span>');
      phase = "menu";
      showMenu();
    }else{
      addMsg('<span class="err">‚úñ Tu n√∫mero no est√° registrado.</span> ' +
             'Por favor, ponte en contacto con el administrador.');
      // permanece en awaiting_phone
    }
    return;
  }

  if(phase === "menu"){
    // tambi√©n permitir escribir 1/2/3
    const mapNum = { "1":"codigo", "2":"hogar", "3":"nueva" };
    const opt = mapNum[text] || text.toLowerCase();
    handleMenu(opt);
    return;
  }
}

/* ===== Eventos ===== */
// Un solo handler para bot√≥n y Enter (submit del form)
formEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  const value = inputEl.value;
  inputEl.value = "";
  await processUserInput(value);
});

window.addEventListener("load", async () => {
  await fetchPhones();
  showWelcome();
});
</script>
</body>
</html>
