<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fox Stream Bot</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f3f6fb; --panel:#ffffff; --bubble:#e9f1ff; --bubble-user:#eaf4ff;
    --text:#0f172a; --muted:#64748b; --brand:#2563eb; --ok:#16a34a;
    --shadow:0 8px 30px rgba(2,6,23,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text); font:16px/1.5 "Inter",system-ui,Segoe UI,Roboto,Arial;
  }
  .wrap{max-width:980px; margin:24px auto; padding:10px}
  .card{background:var(--panel); border-radius:24px; box-shadow:var(--shadow); padding:26px}
  h1{font-size:34px; margin:0 0 4px; text-align:center}
  .sub{color:var(--muted); text-align:center; margin-bottom:18px}
  .chat{border:1px solid #e5e7eb; border-radius:18px; padding:14px; height:min(70vh,720px); background:#fff; overflow:auto}
  .row{display:flex; gap:8px; margin:10px 0}
  .msg{max-width:92%; padding:10px 14px; border-radius:12px}
  .sys{background:var(--bubble)}
  .user{background:var(--bubble-user); margin-left:auto}
  .ok{display:inline-flex; align-items:center; gap:8px; background:#e8f8ee; color:#065f46; border:1px solid #a7f3d0}
  .menu{background:#eef5ff; border:1px dashed #c7d8ff; border-radius:14px; padding:14px; margin:12px 0}
  .menu h4{margin:0 0 10px}
  .opts{display:grid; grid-template-columns:repeat(3,minmax(160px,1fr)); gap:12px}
  .btn{border:1px solid #cfe0ff; background:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; text-align:left}
  .btn strong{display:block}
  .btn:hover{border-color:#9ec0ff}
  .inputbar{display:flex; gap:10px; margin-top:12px}
  input[type=text]{flex:1; padding:14px 16px; border:1px solid #cbd5e1; border-radius:14px; outline:none}
  input[type=text]::placeholder{color:#94a3b8}
  button.send{background:var(--brand); color:#fff; border:none; padding:0 18px; border-radius:12px; cursor:pointer}
  @media (max-width:740px){
    .wrap{padding:8px}
    .opts{grid-template-columns:1fr}
    .chat{height:65vh}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Fox Stream Bot</h1>
    <div class="sub">Soporte autom√°tico 24/7</div>

    <div id="chat" class="chat"></div>

    <div class="inputbar">
      <input id="textbox" type="text" placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)' autocomplete="off" />
      <button id="send" class="send">Enviar</button>
    </div>
  </div>
</div>

<script>
/*** CONFIGURA ESTAS DOS CONSTANTES ***/
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";
const APPS_SCRIPT_URL = ""; // <-- pega aqu√≠ la URL del despliegue web de Apps Script cuando lo crees

/*** UI helpers ***/
const chat = document.getElementById("chat");
const input = document.getElementById("textbox");
const sendBtn = document.getElementById("send");

function bubble(text, cls="sys"){
  const row = document.createElement("div"); row.className="row";
  const msg = document.createElement("div"); msg.className=`msg ${cls}`;
  msg.innerHTML = text;
  row.appendChild(msg); chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
}
function bubbleOk(text){ bubble(`‚úÖ ${text}`, "msg ok"); }
function userBubble(text){ bubble(text, "user"); }

function showMenu(){
  const box = document.createElement("div"); box.className="menu";
  box.innerHTML = `<h4>Selecciona una opci√≥n:</h4>`;
  const grid = document.createElement("div"); grid.className="opts";

  const items = [
    {id:"1", title:"1) C√≥digo de acceso temporal", sub:"Recibe tu PIN de 4 d√≠gitos"},
    {id:"2", title:"2) Actualizar tu Hogar", sub:"Enlace para actualizar ubicaci√≥n"},
    {id:"3", title:"3) Nueva solicitud de inicio (TV)", sub:"Enlace de emparejamiento TV"}
  ];
  items.forEach(it=>{
    const b = document.createElement("button");
    b.className="btn";
    b.innerHTML = `<strong>${it.title}</strong><span>${it.sub}</span>`;
    b.addEventListener("click", ()=> handleMenuSelection(it.id, it.title));
    grid.appendChild(b);
  });

  box.appendChild(grid);
  const row = document.createElement("div"); row.className="row"; row.appendChild(box);
  chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
}

function askEmail(){
  bubble("Por favor, ingresa tu correo:");
  state = "awaitingEmail";
  input.placeholder = "tu@correo.com";
}

/*** Datos/estado ***/
let clients = [];         // [{name, phone}] de la hoja
let state = "awaitingPhone"; // awaitingPhone | menu | awaitingEmail
let selectedOption = null;

// Normaliza a √∫ltimos 9 d√≠gitos; si no hay tantos, usa lo disponible
function lastDigits(s, n=9){
  const d = (s||"").replace(/\D+/g,"");
  return d.slice(-n);
}

async function loadSheet(){
  const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
  const csv = await res.text();
  clients = csv.split(/\r?\n/).slice(1).map(line=>{
    const [name, phone] = line.split(",");
    return { name: (name||"").trim(), phone: (phone||"").trim() };
  }).filter(x=>x.phone);
}

function isAuthorizedNumber(num){
  const d = lastDigits(num);
  return clients.some(c => lastDigits(c.phone) === d || lastDigits(c.phone,8) === lastDigits(num,8));
}

/*** Flujo ***/
function resetToHome(){
  state = "awaitingPhone";
  selectedOption = null;
  input.value="";
  input.placeholder = 'Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)';
  bubble('üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.');
}

function handleMenuSelection(id, title){
  userBubble(id);
  selectedOption = id;
  askEmail();
}

async function resolveAction(optionId, email){
  // Si configuraste APPS_SCRIPT_URL, llamamos al backend para traer c√≥digo/enlace real.
  if(APPS_SCRIPT_URL){
    const url = `${APPS_SCRIPT_URL}?opt=${encodeURIComponent(optionId)}&email=${encodeURIComponent(email)}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error("Error en el servidor");
    return await r.json(); // {ok:true, message:"..."}
  }
  // MODO DEMO (sin backend): textos de ejemplo
  if(optionId==="1"){
    return {ok:true, message:`Tu c√≥digo es: <strong>0269</strong><br> Tienes 15 minutos para ingresarlo.`};
  }
  if(optionId==="2"){
    return {ok:true, message:`Tu enlace es: <a target="_blank" href="https://www.netflix.com/account/update-primary-location?nftoken=DEMO">https://www.netflix.com/account/update-primary-location?nftoken=DEMO</a><br>Tienes 15 minutos para ingresarlo.`};
  }
  if(optionId==="3"){
    return {ok:true, message:`Tu enlace es: <a target="_blank" href="https://www.netflix.com/ilu?code=DEMO">https://www.netflix.com/ilu?code=DEMO</a><br>Tienes 15 minutos para ingresarlo.`};
  }
  return {ok:false, message:"Opci√≥n no v√°lida."};
}

async function onSubmit(){
  const text = input.value.trim();
  if(!text) return;

  if(state==="awaitingPhone"){
    userBubble(text);
    const ok = isAuthorizedNumber(text);
    if(ok){
      bubbleOk("N√∫mero verificado. ¬°Bienvenido!");
      state="menu";
      showMenu();
      input.value=""; input.placeholder='Escribe "hola" para volver al men√∫ principal.';
    }else{
      bubble('‚ùå El n√∫mero no est√° registrado. Ponte en contacto con el administrador.');
      input.value="";
    }
    return;
  }

  if(state==="menu"){
    // Permitir teclear 1/2/3 adem√°s de click
    if(/^[123]$/.test(text)){
      const t = text==="1"?"1) C√≥digo de acceso temporal": text==="2"?"2) Actualizar tu Hogar":"3) Nueva solicitud de inicio (TV)";
      handleMenuSelection(text, t);
      input.value="";
      return;
    }
  }

  if(state==="awaitingEmail"){
    userBubble(text);
    // Validaci√≥n simple de email
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(text)){
      bubble("‚ö†Ô∏è Ingresa un correo v√°lido, por favor.");
      return;
    }
    try{
      const resp = await resolveAction(selectedOption, text);
      if(resp.ok){
        bubble(`üì® ${resp.message}`);
        bubble(`Escribe <strong>"hola"</strong> para volver al men√∫ principal.`);
      }else{
        bubble("‚ö†Ô∏è No pude obtener la informaci√≥n. Intenta otra vez en unos segundos.");
      }
    }catch(e){
      bubble("‚ö†Ô∏è Ocurri√≥ un error al consultar. Intenta nuevamente.");
    }
    state="menu"; // permite pedir otra acci√≥n o escribir "hola"
    input.value="";
    input.placeholder='Escribe "hola" para volver al men√∫ principal.';
    return;
  }

  // Comando 'hola' en cualquier momento para reiniciar
  if(text.toLowerCase()==="hola"){
    bubble(`"hola"`);
    resetToHome();
    input.value="";
    return;
  }
}

// Eventos
sendBtn.addEventListener("click", onSubmit);
input.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); onSubmit(); }});

// Init
(async ()=>{
  await loadSheet();
  resetToHome();
})();
</script>
</body>
</html>
