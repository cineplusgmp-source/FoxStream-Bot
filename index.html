<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fox Stream Bot</title>
<link href="https://unpkg.com/@picocss/pico@2/css/pico.min.css" rel="stylesheet">
<style>
  :root { --radius: 14px; }
  main { max-width: 920px; margin:auto; }
  .chat { border:1px solid #e5e7eb; border-radius: var(--radius); padding:1rem; background:#fff; }
  .bubble { display:inline-block; padding:.6rem .8rem; border-radius: 12px; background:#eaf2ff; color:#111; }
  .bubble.me { background:#f1f5f9; }
  .badge { background:#e6ffed; color:#0a7f3f; border:1px solid #b7f7cc; }
  .badge.error { background:#ffe6e6; color:#a40000; border-color:#ffb3b3; }
  .options { background:#eef5ff; border:1px dashed #c7dafd; padding:.8rem; border-radius:12px; }
  .btnopt { display:inline-block; margin:.35rem .35rem 0 0; padding:.55rem .8rem; border-radius:999px; border:1px solid #c7dafd; background:#fff; color:#0f172a; font-weight:600; }
  .muted { color:#6b7280; font-size:.9rem; }
  .inputrow { display:flex; gap:.6rem; position:sticky; bottom:0; background:#f8fafc; padding:.6rem; border:1px solid #e5e7eb; border-radius: var(--radius); }
  #input { flex:1; }
</style>
</head>
<body>
<main>
  <h1 style="text-align:center;margin:12px 0 4px;">Fox Stream Bot</h1>
  <p style="text-align:center;margin-top:0;color:#6b7280">Soporte autom√°tico 24/7</p>

  <section class="chat" id="chat">
    <p class="bubble">üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.</p>
  </section>

  <div class="inputrow">
    <input id="input" type="text" placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)' />
    <button id="send" class="contrast">Enviar</button>
  </div>
  <p class="muted">Tip: presiona Enter para enviar.</p>
</main>

<script>
/* ====== CONFIG ====== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzPn0AeY6bKK5onUhfXeiWbSK_Pu3kNK-JI1qozE_OdxP4hAvo2_Jvmbv_lmRTvaarE/exec";
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";

/* ====== STATE ====== */
let state = {
  phase: "askPhone", // askPhone -> menu -> waitingEmail -> done
  phoneOk: false,
  choice: null // 1,2,3
};
let allowedPhones = null; // Set de n√∫meros normalizados (√∫ltimos 8‚Äì9 d√≠gitos)

/* ====== UI ====== */
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const send  = document.getElementById("send");

function addBubble(text, me=false, extraClass="") {
  const p = document.createElement("p");
  p.className = "bubble" + (me ? " me" : "") + (extraClass ? " "+extraClass : "");
  p.textContent = text;
  chat.appendChild(p);
  chat.scrollTop = chat.scrollHeight;
}
function addBadge(text, isError=false) {
  const span = document.createElement("span");
  span.className = "bubble " + (isError ? "error badge" : "badge");
  span.textContent = text;
  chat.appendChild(span);
  chat.scrollTop = chat.scrollHeight;
}
function addOptions() {
  const wrap = document.createElement("div");
  wrap.className = "options";
  wrap.innerHTML = `<strong>Selecciona una opci√≥n:</strong><br/>`;

  const opts = [
    ["1","1) C√≥digo de acceso temporal"],
    ["2","2) Actualizar tu Hogar"],
    ["3","3) Nueva solicitud de inicio (TV)"],
  ];
  for (const [val,label] of opts) {
    const b = document.createElement("button");
    b.className = "btnopt";
    b.textContent = label;
    b.onclick = () => handleUser(val);
    wrap.appendChild(b);
  }
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}
function askEmail() {
  addBubble("Por favor, ingresa tu correo sin espacios:");
  state.phase = "waitingEmail";
}

/* ====== HELPERS ====== */
function norm(n) {
  // deja solo d√≠gitos y toma √∫ltimos 9 (si el pa√≠s usa 9) o 8
  const digits = String(n).replace(/\D/g,"");
  return digits.slice(-9); // ajusta a -8 si tus n√∫meros son de 8 d√≠gitos
}
async function loadPhones() {
  const res = await fetch(SHEET_CSV);
  const text = await res.text();
  const lines = text.split(/\r?\n/);
  const set = new Set();
  // asumimos encabezados: Nombre, Tel√©fono
  for (let i=1;i<lines.length;i++){
    const row = lines[i].split(",");
    if (row.length < 2) continue;
    const phone = norm(row[1]);
    if (phone) set.add(phone);
  }
  return set;
}

/* ====== BOT LOGIC ====== */
async function handleUser(raw) {
  const msg = String(raw).trim();
  if (!msg) return;

  // pinta burbuja del usuario
  addBubble(msg, true);

  // limpia input
  input.value = "";

  if (state.phase === "askPhone") {
    if (!allowedPhones) {
      try {
        allowedPhones = await loadPhones();
      } catch {
        addBadge("No pude cargar la lista de clientes, intenta m√°s tarde.", true);
        return;
      }
    }
    const phone = norm(msg);
    if (!/^\d{7,12}$/.test(phone)) {
      addBadge("N√∫mero inv√°lido. Escribe solo d√≠gitos.", true);
      return;
    }
    if (!allowedPhones.has(phone) && !allowedPhones.has(phone.slice(-8))) {
      addBadge("Tu n√∫mero no est√° registrado. Por favor, cont√°ctate con el administrador.", true);
      addBubble('Escribe "hola" para volver al men√∫ principal.');
      return;
    }
    state.phoneOk = true;
    state.phase = "menu";
    addBadge("N√∫mero verificado. ¬°Bienvenido!");
    addOptions();
    return;
  }

  if (state.phase === "menu") {
    if (!["1","2","3"].includes(msg)) {
      addBadge("Respuesta inv√°lida. Elige 1, 2 o 3.", true);
      return;
    }
    state.choice = msg;
    askEmail();
    return;
  }

  if (state.phase === "waitingEmail") {
    const email = msg.toLowerCase();
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
      addBadge("Correo inv√°lido. Intenta de nuevo.", true);
      return;
    }
    addBubble("‚è≥ Consultando tu correo...");

    try {
      const url = `${GAS_URL}?type=${encodeURIComponent(state.choice)}&email=${encodeURIComponent(email)}`;
      const res = await fetch(url, { method: "GET" });

      // CORRECTO: en navegador se usa res.ok / res.json() / res.headers.get()
      if (!res.ok) {
        addBadge(`Error HTTP ${res.status}. Intenta m√°s tarde.`, true);
        addBubble('Escribe "hola" para volver al men√∫ principal.');
        return;
      }
      const data = await res.json();

      if (!data.ok) {
        addBadge(data.message || "No se encontr√≥ ning√∫n correo enviado. Verifique que haya enviado el c√≥digo o el enlace y vuelva a intentarlo.", true);
        addBubble('Escribe "hola" para volver al men√∫ principal.');
        state.phase = "menu";
        return;
      }

      if (state.choice === "1" && data.code) {
        addBubble(`Tu c√≥digo es: ${data.code}\nTienes 15 minutos para ingresarlo.`);
      } else if ((state.choice === "2" || state.choice === "3") && data.link) {
        addBubble(`Tu enlace es: ${data.link}\nTienes 15 minutos para ingresarlo.`);
      } else {
        addBadge("No se encontr√≥ informaci√≥n utilizable en el √∫ltimo correo. Vuelve a solicitar desde tu TV/app y reintenta.", true);
      }

    } catch (err) {
      addBadge("Error de red: " + err, true);
    }

    addBubble('Escribe "hola" para volver al men√∫ principal.');
    state.phase = "menu";
    return;
  }

  // Reinicio r√°pido
  if (/^hola$/i.test(msg)) {
    state = { phase:"askPhone", phoneOk:false, choice:null };
    addBubble("üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.");
    return;
  }
}

/* ====== EVENTS ====== */
send.addEventListener("click", () => handleUser(input.value));
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") handleUser(input.value);
});

// Enfoque inicial
input.focus();
</script>
</body>
</html>
