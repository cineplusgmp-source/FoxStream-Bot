<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fox Stream Bot</title>
  <style>
    :root{
      --bg:#f3f6fb; --card:#ffffff; --primary:#1b62ff; --ink:#0f172a;
      --bubble:#e9f1ff; --ok:#16a34a; --muted:#64748b; --ring:#dbe7ff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--ink); background:var(--bg);
    }
    .wrap{
      max-width:980px; margin-inline:auto; padding:28px 16px;
    }
    header{
      text-align:center; margin-bottom:16px;
    }
    header h1{ font-size:clamp(24px, 3vw, 36px); margin:0 0 6px}
    header p{ color:var(--muted); margin:0; font-size:14px}
    .card{
      background:var(--card); border-radius:24px; padding:14px;
      box-shadow:0 10px 30px rgba(16,24,40,.08);
      border:1px solid #eef2ff;
    }
    .chat{
      border:1px solid var(--ring); border-radius:18px; padding:12px;
      min-height:min(62vh, 560px); max-height:70vh; overflow:auto;
      background:#fff;
    }
    .row{display:flex; gap:10px; margin-top:10px}
    .bot,.me{
      max-width:min(95%,720px); padding:10px 12px; border-radius:12px;
      line-height:1.35; font-size:15px;
    }
    .bot{background:var(--bubble)}
    .me{background:#eef2ff}
    .pill{background:#e8efff; padding:4px 10px; border-radius:20px; display:inline-block}
    .ok{color:#0f5132; background:#dcfce7; border:1px solid #86efac}
    .choices{background:#eef4ff; border:1px dashed #c7d6ff; border-radius:14px; padding:12px}
    .choices .btn{
      display:inline-block; margin:6px 8px 0 0; border:1px solid #cfe0ff; border-radius:12px;
      padding:10px 12px; cursor:pointer; background:#fff; font-size:14px;
    }
    .composer{
      margin-top:12px; display:flex; gap:10px; align-items:center;
    }
    input[type="text"]{
      flex:1; padding:14px 14px; border:1px solid var(--ring); border-radius:12px;
      font-size:15px; outline:none;
    }
    input[type="text"]:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(27,98,255,.15)}
    button{
      border:none; background:var(--primary); color:#fff; padding:12px 16px; border-radius:12px;
      cursor:pointer; font-weight:600;
    }
    .muted{color:var(--muted)}
    @media (max-width:640px){
      .chat{min-height:50vh; max-height:62vh}
      .choices .btn{display:block}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Fox Stream Bot</h1>
      <p>Soporte autom√°tico 24/7</p>
    </header>

    <div class="card">
      <div id="chat" class="chat" aria-live="polite" aria-label="Conversaci√≥n">
        <!-- Mensaje inicial -->
        <div class="row">
          <div class="bot">üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.</div>
        </div>
      </div>

      <form id="composer" class="composer" autocomplete="off">
        <input
          id="input"
          type="text"
          inputmode="numeric"
          placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)'
          aria-label='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)'
        />
        <button type="submit">Enviar</button>
      </form>
    </div>
  </div>

  <script>
    // üëâ Pega aqu√≠ el enlace CSV de tu Google Sheet publicado:
    // (Archivo > Compartir > Publicar en la Web > Hoja 1 > "Valores separados por comas (CSV)")
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";

    // Estado de la conversaci√≥n
    const State = {
      step: "await_phone", // await_phone -> menu -> flow_1_phone -> flow_1_email -> done
      verifiedPhone: null,
      pendingChoice: null, // "1" | "2" | "3"
      tmpPhoneForFlow: null,
      db: [] // [{name, phoneRaw, phoneTail}]
    };

    const $chat   = document.getElementById("chat");
    const $form   = document.getElementById("composer");
    const $input  = document.getElementById("input");

    // --- Utils ---
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
    const toDigits = (s)=> (s||"").replace(/\D+/g,"");
    const lastNDigits = (s, n)=> toDigits(s).slice(-n);

    function addBot(text, classes=""){
      const row = document.createElement("div");
      row.className = "row";
      const b = document.createElement("div");
      b.className = "bot " + classes;
      b.textContent = text;
      row.appendChild(b);
      $chat.appendChild(row);
      $chat.scrollTop = $chat.scrollHeight;
    }
    function addMe(text){
      const row = document.createElement("div");
      row.className = "row";
      const me = document.createElement("div");
      me.className = "me pill";
      me.textContent = text;
      row.appendChild(me);
      $chat.appendChild(row);
      $chat.scrollTop = $chat.scrollHeight;
    }
    function addChoices(){
      const row = document.createElement("div");
      row.className = "row";
      const box = document.createElement("div");
      box.className = "bot choices";
      box.innerHTML = `
        <div style="font-weight:700; margin-bottom:6px">Selecciona una opci√≥n:</div>
        <button type="button" class="btn" data-choice="1">1) C√≥digo de acceso temporal</button>
        <button type="button" class="btn" data-choice="2">2) Actualizar tu Hogar</button>
        <button type="button" class="btn" data-choice="3">3) Nueva solicitud de inicio (TV)</button>
      `;
      box.addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-choice]");
        if(!btn) return;
        handleText(btn.dataset.choice);
      });
      row.appendChild(box);
      $chat.appendChild(row);
      $chat.scrollTop = $chat.scrollHeight;
    }
    function endWithHomeHint(){
      const row = document.createElement("div");
      row.className = "row";
      const b = document.createElement("div");
      b.className = "bot";
      b.innerHTML = `Escribe <b>"hola"</b> para volver al men√∫ principal.`;
      row.appendChild(b);
      $chat.appendChild(row);
      $chat.scrollTop = $chat.scrollHeight;
      $input.placeholder = 'Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)';
    }

    // --- Carga la base (CSV) ---
    async function loadDB(){
      try{
        const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/);
        // Asumimos cabecera: Nombre,Tel√©fono
        State.db = rows.slice(1).map(line=>{
          const [name, phone] = line.split(/,(.+)/); // solo primera coma
          const phoneRaw = toDigits(phone||"");
          const tail9 = lastNDigits(phoneRaw, 9);
          const tail8 = lastNDigits(phoneRaw, 8);
          return { name: (name||"").trim(), phoneRaw, phoneTail8: tail8, phoneTail9: tail9 };
        });
      }catch(e){
        addBot("‚ö†Ô∏è No pude cargar la lista de clientes. Revisa el enlace del Google Sheet.");
      }
    }

    function matchPhone(userInput){
      const d = toDigits(userInput);
      if(!d) return null;
      const t9 = lastNDigits(d, 9);
      const t8 = lastNDigits(d, 8);
      // Coincidimos por los √∫ltimos 9 o 8 d√≠gitos
      return State.db.find(row => row.phoneTail9 === t9 || row.phoneTail8 === t8) || null;
    }

    // --- Flujo principal ---
    async function resetToHome(){
      State.step = "await_phone";
      State.verifiedPhone = null;
      State.pendingChoice = null;
      State.tmpPhoneForFlow = null;
      $chat.innerHTML = "";
      addBot("üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.");
      $input.value = "";
      $input.placeholder = 'Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)';
      $input.focus();
    }

    async function handleText(raw){
      const text = (raw||"").trim();

      // Reinicio r√°pido
      if(text.toLowerCase() === "hola"){
        addMe(text);
        await sleep(150);
        return resetToHome();
      }

      // M√°quina de estados
      if(State.step === "await_phone"){
        addMe(text);
        await sleep(120);

        const hit = matchPhone(text);
        if(!hit){
          addBot("‚ùå Ese n√∫mero no est√° registrado. Por favor, contacta al administrador.");
          endWithHomeHint();
          return;
        }
        State.verifiedPhone = hit;
        const okRow = document.createElement("div");
        okRow.className = "row";
        const ok = document.createElement("div");
        ok.className = "bot ok";
        ok.textContent = "‚úî N√∫mero verificado. ¬°Bienvenido!";
        okRow.appendChild(ok);
        $chat.appendChild(okRow);

        State.step = "menu";
        addChoices();
        $input.value = "";
        $input.placeholder = 'Escribe 1, 2 o 3';
        return;
      }

      if(State.step === "menu"){
        addMe(text);
        const choice = text.trim();
        if(!/^[123]$/.test(choice)){
          addBot("Por favor, responde con 1, 2 o 3.");
          return;
        }
        State.pendingChoice = choice;

        if(choice === "1"){
          State.step = "flow_1_phone";
          addBot("Por favor, ingresa tu n√∫mero sin espacios:");
          $input.value = "";
          $input.placeholder = "Ej: 934231163";
          return;
        }
        if(choice === "2"){
          State.step = "flow_2_phone";
          addBot("Por favor, ingresa tu n√∫mero sin espacios:");
          $input.value = "";
          $input.placeholder = "Ej: 934231163";
          return;
        }
        if(choice === "3"){
          // Mensaje informativo
          addBot("üì∫ Listo. Generaremos una nueva solicitud de inicio. Te avisaremos por WhatsApp cuando est√© activa.");
          endWithHomeHint();
          State.step = "done";
          return;
        }
      }

      if(State.step === "flow_1_phone"){
        addMe(text);
        State.tmpPhoneForFlow = toDigits(text);
        State.step = "flow_1_email";
        addBot("Ahora ingresa tu correo:");
        $input.value = "";
        $input.placeholder = "tu@correo.com";
        return;
      }

      if(State.step === "flow_1_email"){
        addMe(text);
        // Simulamos c√≥digo de 4 d√≠gitos
        const code = Math.floor(1000 + Math.random()*9000);
        addBot(`üîê Tu c√≥digo es: ${code}\nTienes 15 minutos para ingresarlo.`);
        endWithHomeHint();
        State.step = "done";
        return;
      }

      if(State.step === "flow_2_phone"){
        addMe(text);
        State.tmpPhoneForFlow = toDigits(text);
        State.step = "flow_2_email";
        addBot("Ahora ingresa tu correo:");
        $input.value = "";
        $input.placeholder = "tu@correo.com";
        return;
      }

      if(State.step === "flow_2_email"){
        addMe(text);
        // Enlace largo de ejemplo (simula el de Netflix)
        const url = "https://www.netflix.com/account/update-primary-location?nfToken=EjemploTokenLargo123";
        addBot(`üîó Tu enlace es: ${url}\nTienes 15 minutos para ingresarlo.`);
        endWithHomeHint();
        State.step = "done";
        return;
      }

      // Si ya finaliz√≥ un flujo
      if(State.step === "done"){
        addBot('Escribe "hola" para volver al men√∫ principal.');
      }
    }

    // --- Eventos de env√≠o (bot√≥n + ENTER) ---
    $form.addEventListener("submit", (e)=>{
      e.preventDefault();
      const v = $input.value.trim();
      if(!v) return;
      handleText(v);
      $input.value = "";
    });
    // Enter funciona por defecto v√≠a submit del form,
    // pero aseguramos en m√≥viles con teclados ‚Äúdone‚Äù
    $input.addEventListener("keydown",(e)=>{
      if(e.key === "Enter"){
        // El submit del form lo gestionar√°
      }
    });

    // Inicializa
    (async ()=>{
      await loadDB();
      // listo para usar
    })();
  </script>
</body>
</html>
