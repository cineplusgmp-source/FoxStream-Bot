<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fox Stream Bot</title>
  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --primary:#2563eb;
      --primary-weak:#e8f0ff;
      --text:#0f172a;
      --muted:#64748b;
      --ok:#16a34a;
      --bubble:#e9f1ff;
      --radius:16px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;}
    .wrap{max-width:960px;margin:28px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:24px;padding:24px;box-shadow:0 6px 24px rgba(15,23,42,.06)}
    .title{font-size:clamp(22px,3.3vw,38px);font-weight:800;letter-spacing:.3px;text-align:center;margin:4px 0 2px}
    .subtitle{font-size:14px;color:var(--muted);text-align:center;margin-bottom:18px}
    .chat{border:1px solid #e7e9ee;border-radius:20px;min-height:48vh;max-height:74vh;overflow:auto;background:#fff;padding:16px}
    .row{display:flex;gap:10px;margin:10px 0}
    .bot{background:var(--bubble);border-radius:14px;padding:10px 12px;max-width:90%;box-shadow:inset 0 0 0 1px rgba(37,99,235,.06)}
    .user{background:#eef2ff;border-radius:14px;padding:8px 10px;font-size:14px;color:#334155}
    .ok{color:#0a7e34;font-weight:700}
    .btns{background:#edf2ff;border:1px solid #dbe7ff;border-radius:14px;padding:12px;display:flex;flex-wrap:wrap;gap:10px}
    .chip{border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;background:#fff;cursor:pointer}
    .chip:hover{background:#f1f5ff;border-color:#94a3b8}
    .bar{display:flex;gap:10px;margin-top:14px}
    .in{flex:1;border:1px solid #dfe3ea;border-radius:12px;padding:12px 14px;font-size:15px}
    .send{background:var(--primary);color:#fff;border:0;border-radius:12px;padding:0 16px;font-weight:600;cursor:pointer}
    .send:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:#64748b;font-size:12px;margin-top:6px}
    @media(min-width:900px){
      .chat{min-height:55vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">Fox Stream Bot</div>
      <div class="subtitle">Soporte autom√°tico 24/7</div>

      <div id="chat" class="chat"></div>

      <div class="bar">
        <input id="msg" class="in" type="text"
          placeholder='Tu n√∫mero (solo d√≠gitos) o escribe "hola". Puedes escribir solo tus d√≠gitos locales; no necesitas c√≥digo de pa√≠s.' />
        <button id="send" class="send">Enviar</button>
      </div>
      <div class="hint">Sugerencia: en computadora puedes presionar <b>Enter</b> para enviar.</div>
    </div>
  </div>

  <script>
  // ================== CONFIG ==================
  // URL publicada como CSV (Compartir > Publicar en la Web > Hoja 1 > CSV)
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";

  // Cu√°ntos d√≠gitos m√≠nimos debe escribir el cliente para validar
  const MIN_LOCAL_DIGITS = 8; // usualmente 8‚Äì9; aj√∫stalo si lo necesitas
  // ============================================

  const chat = document.getElementById('chat');
  const input = document.getElementById('msg');
  const btn = document.getElementById('send');

  let customers = []; // {name, phoneDigits}
  let verified = false;

  function normalizeDigits(s) {
    return (s || '').replace(/\D+/g, '');
  }

  function scrollToBottom() {
    chat.scrollTop = chat.scrollHeight;
  }

  function bubbleBot(html) {
    const row = document.createElement('div');
    row.className = 'row';
    const b = document.createElement('div');
    b.className = 'bot';
    b.innerHTML = html;
    row.appendChild(b);
    chat.appendChild(row);
    scrollToBottom();
  }

  function bubbleUser(text) {
    const row = document.createElement('div');
    row.className = 'row';
    const b = document.createElement('div');
    b.className = 'user';
    b.textContent = text;
    row.appendChild(b);
    chat.appendChild(row);
    scrollToBottom();
  }

  function askForPhone() {
    bubbleBot('üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.');
  }

  function showMenu() {
    const wrap = document.createElement('div');
    wrap.className = 'btns row';
    wrap.innerHTML = `
      <div style="min-width:140px"><b>Selecciona una opci√≥n:</b></div>
      <button class="chip" data-opt="1">1) C√≥digo de acceso temporal</button>
      <button class="chip" data-opt="2">2) Actualizar tu Hogar</button>
      <button class="chip" data-opt="3">3) Nueva solicitud de inicio (TV)</button>
    `;
    chat.appendChild(wrap);
    wrap.querySelectorAll('.chip').forEach(ch => {
      ch.addEventListener('click', () => handleOption(ch.dataset.opt));
    });
    scrollToBottom();
  }

  function afterFlowMessage() {
    bubbleBot('Escribe "<b>hola</b>" para volver al men√∫ principal.');
  }

  function handleOption(opt) {
    const text = {
      '1': 'C√≥digo de acceso temporal',
      '2': 'Actualizar tu Hogar',
      '3': 'Nueva solicitud de inicio (TV)'
    }[opt] || 'Opci√≥n';
    bubbleUser(text);

    // Aqu√≠ pones la l√≥gica real con tus sistemas.
    if (opt === '1') {
      bubbleBot('Tu c√≥digo temporal es: <b>123-456</b> (demo).');
    } else if (opt === '2') {
      bubbleBot('Se ha registrado tu solicitud de actualizaci√≥n de hogar. Te avisaremos por WhatsApp cuando est√© lista.');
    } else if (opt === '3') {
      bubbleBot('Hemos iniciado el proceso para tu nueva solicitud de inicio en TV. Te contactaremos por WhatsApp.');
    }
    afterFlowMessage();
  }

  function validatePhone(inputDigits) {
    if (!inputDigits || inputDigits.length < MIN_LOCAL_DIGITS) {
      bubbleBot(`Por favor escribe al menos <b>${MIN_LOCAL_DIGITS}</b> d√≠gitos de tu n√∫mero sin espacios.`);
      return false;
    }

    // Coincidencia por sufijo: si lo que escribe el cliente coincide
    // con el final de alg√∫n tel√©fono de la lista, lo consideramos v√°lido.
    const found = customers.find(c => c.phoneDigits.endsWith(inputDigits));
    if (found) {
      verified = true;
      bubbleBot('‚úÖ <span class="ok">N√∫mero verificado. ¬°Bienvenido!</span>');
      showMenu();
      return true;
    } else {
      bubbleBot('‚ùå No encontramos tu n√∫mero. Por favor, contacta al administrador para registrarte.');
      return false;
    }
  }

  async function loadSheet() {
    try {
      const res = await fetch(SHEET_CSV_URL, {cache: 'no-store'});
      const csv = await res.text();

      // Parseo muy simple de CSV (2 columnas: Nombre, Tel√©fono)
      // Si tu hoja puede tener comas en el nombre, ser√≠a mejor un parser CSV completo,
      // pero para esta hoja simple funciona.
      const rows = csv.split(/\r?\n/).filter(r => r.trim() !== '');
      const header = rows.shift(); // "Nombre,Tel√©fono"
      customers = rows.map(line => {
        const parts = line.split(',');
        const name = (parts[0] || '').trim();
        const phoneDigits = normalizeDigits(parts[1] || '');
        return { name, phoneDigits };
      }).filter(r => r.phoneDigits.length > 0);
    } catch (e) {
      console.error(e);
      bubbleBot('‚ö†Ô∏è No pude cargar la lista de clientes. Verifica el enlace CSV publicado.');
    }
  }

  function resetToMenu() {
    verified = true; // ya estaba verificado
    showMenu();
  }

  async function start() {
    await loadSheet();
    askForPhone();
    input.focus();
  }

  async function send() {
    const raw = input.value.trim();
    if (!raw) return;
    input.value = '';

    bubbleUser(raw);

    if (/^hola$/i.test(raw)) {
      if (verified) {
        resetToMenu();
      } else {
        askForPhone();
      }
      return;
    }

    if (!verified) {
      const digits = normalizeDigits(raw);
      validatePhone(digits);
      return;
    }

    // Ya verificado => interpretar selecci√≥n por n√∫mero
    const m = raw.match(/^[123]$/);
    if (m) {
      handleOption(m[0]);
    } else {
      bubbleBot('Por favor elige una opci√≥n v√°lida (1, 2 o 3) o escribe "hola" para volver al men√∫.');
    }
  }

  btn.addEventListener('click', send);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      send();
    }
  });

  start();
  </script>
</body>
</html>
