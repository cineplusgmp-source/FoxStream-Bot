<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fox Stream Bot</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --primary:#2563eb; --muted:#6b7280;
    --bot:#e9f2ff; --ok:#dcfce7; --bad:#fee2e2; --chip:#eef4ff; --chip-border:#cfe2ff; --chip-text:#0b5ed7;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .title{font-weight:800;font-size:40px;text-align:center;margin:8px 0 4px}
  .sub{color:var(--muted);text-align:center;margin:0 0 18px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.06);padding:14px 14px 4px}
  .chat{height:58vh;min-height:360px;max-height:70vh;overflow:auto;border:1px solid #eef1f6;border-radius:12px;padding:14px;background:#fff}
  .row{display:flex;margin:10px 0}
  .msg{max-width:85%;padding:10px 14px;border-radius:12px}
  .bot{background:var(--bot)}
  .user{background:#eef2ff;margin-left:auto}
  .ok{background:var(--ok)}
  .bad{background:var(--bad)}
  .pill{display:inline-block;background:var(--chip);border:1px solid var(--chip-border);color:var(--chip-text);
        padding:8px 12px;border-radius:10px;margin:6px 10px 0 0;cursor:pointer;user-select:none}
  .pill:hover{filter:brightness(.97)}
  .options{background:var(--bot);padding:12px;border-radius:12px;border:1px dashed #bfd7ff}
  .inputbar{display:flex;gap:10px;margin:12px 0 18px}
  .inputbar input{flex:1;padding:14px;border-radius:10px;border:1px solid #dde3ee;font-size:16px}
  .inputbar button{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:0 18px;font-weight:600}
  .tip{color:#9aa0a6;font-size:13px;margin-top:-6px}
  @media (max-width:520px){
    .title{font-size:30px}
    .chat{height:64vh}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1 class="title">Fox Stream Bot</h1>
  <p class="sub">Soporte autom√°tico 24/7</p>

  <div class="card">
    <div id="chat" class="chat"></div>

    <form id="form" class="inputbar" autocomplete="off">
      <input id="text" type="text" placeholder='Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)' autocomplete="off" />
      <button id="send" type="submit">Enviar</button>
    </form>
    <div class="tip">Tip: presiona Enter para enviar.</div>
  </div>
</div>

<script>
/* ---------------- CONFIG: pon tus enlaces aqu√≠ ----------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbzPn0AeY6bKK5onUhfXeiWbSK_Pu3kNK-JI1qozE_OdxP4hAvo2_Jvmbv_lmRTvaarE/exec";
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";
/* --------------------------------------------------------------- */

const chat = document.getElementById('chat');
const input = document.getElementById('text');
const form  = document.getElementById('form');
const sendBtn = document.getElementById('send');

let state = "await_phone"; // await_phone -> await_option -> await_email
let selectedType = null;
let cachedPhones = null;

// UI helpers
function scrollDown(){ chat.scrollTop = chat.scrollHeight; }
function bubble(text, who="bot", cls=""){
  const row = document.createElement('div'); row.className = "row";
  const b = document.createElement('div'); b.className = `msg ${who==="bot"?"bot":"user"} ${cls}`;
  b.innerText = text; row.appendChild(b); chat.appendChild(row); scrollDown();
}
function optionsUI(){
  const row = document.createElement('div'); row.className = 'row';
  const box = document.createElement('div'); box.className = 'msg bot options'; row.appendChild(box);
  const title = document.createElement('div'); title.style.marginBottom = "6px"; title.style.fontWeight = "700";
  title.innerText = "Selecciona una opci√≥n:"; box.appendChild(title);
  box.append(chip("1) C√≥digo de acceso temporal", ()=>pick(1)),
             chip("2) Actualizar tu Hogar", ()=>pick(2)),
             chip("3) Nueva solicitud de inicio (TV)", ()=>pick(3)));
  chat.appendChild(row); scrollDown();
}
function chip(label,onclick){ const c=document.createElement('span'); c.className='pill'; c.innerText=label; c.onclick=onclick; return c; }

// Utils
const onlyDigits = s => (s||"").replace(/\D+/g,"");
function endsWithAnyCountry(phoneSheet, userLocal){
  const a = onlyDigits(phoneSheet);
  const b = onlyDigits(userLocal);
  return a.endsWith(b);
}

async function loadPhones(){
  if (cachedPhones) return cachedPhones;
  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  const csv = await res.text();
  const lines = csv.split(/\r?\n/).filter(Boolean);
  const phones = [];
  for (let i=1;i<lines.length;i++){
    const parts = lines[i].split(',');
    const phone = (parts[1]||"").trim();
    if (phone) phones.push(phone);
  }
  cachedPhones = phones;
  return phones;
}

// Flow
function reset(){
  state = "await_phone"; selectedType = null;
  chat.innerHTML = "";
  bubble("üëã ¬°Hola! Escribe tu n√∫mero de tel√©fono para validar tu acceso.");
  input.placeholder = 'Escribe tu n√∫mero de tel√©fono (solo d√≠gitos)';
  input.value = "";
  input.focus();
}

async function onSend(){
  const text = input.value.trim();
  if (!text) return;

  // reinicio
  if (text.toLowerCase() === "hola"){ bubble(text, "user"); input.value=""; reset(); return; }

  if (state === "await_phone"){
    bubble(text, "user"); input.value="";
    const ok = await verifyPhone(text);
    if (!ok){
      bubble("‚ùå Tu n√∫mero no est√° registrado. Por favor, cont√°ctate con el administrador.","bot","bad");
      bubble('Escribe "hola" para volver al men√∫ principal.');
      input.placeholder = 'Escribe "hola" para reiniciar';
      return;
    }
    bubble("N√∫mero verificado. ¬°Bienvenido!","bot","ok");
    optionsUI();
    state = "await_option";
    input.placeholder = 'Escribe 1, 2 o 3';
    return;
  }

  if (state === "await_option"){
    bubble(text, "user"); input.value="";
    const n = Number(text);
    if (![1,2,3].includes(n)){ bubble("Por favor, elige 1, 2 o 3."); return; }
    pick(n);
    return;
  }

  if (state === "await_email"){
    const email = text.toLowerCase();
    bubble(email, "user"); input.value="";
    await resolveWithEmail(email);
    return;
  }
}

function pick(n){
  selectedType = n;
  const row = document.createElement('div'); row.className="row";
  const b = document.createElement('div'); b.className="msg user"; b.innerText=String(n);
  row.appendChild(b); chat.appendChild(row); scrollDown();

  bubble("Por favor, ingresa tu correo sin espacios:");
  input.placeholder = 'tu@correo.com';
  input.value = "";
  input.focus();
  state = "await_email";
}

async function verifyPhone(userNumber){
  try{
    const phones = await loadPhones();
    return phones.some(p => endsWithAnyCountry(p, userNumber));
  }catch(e){
    bubble("‚ö†Ô∏è No se pudo validar el n√∫mero en este momento.","bot","bad");
    return false;
  }
}

async function resolveWithEmail(email){
  bubble("‚è≥ Consultando tu correo...", "bot");
  try{
    const url = `${API_URL}?type=${encodeURIComponent(selectedType)}&email=${encodeURIComponent(email)}&v=${Date.now()}`;
    const res = await fetch(url, { method: "GET", cache: "no-store" });
    const data = await res.json();  // <- NUNCA usamos getResponseHeaders en el navegador

    if (!data.ok){
      const msg = data.message || "No se encontr√≥ ning√∫n correo enviado. Verifique que haya enviado el c√≥digo o el enlace. Vuelva a intentarlo una vez lo haya hecho.";
      bubble(`Error: ${msg}`, "bot", "bad");
      bubble('Escribe "hola" para volver al men√∫ principal.');
      input.placeholder = 'Escribe "hola" para reiniciar';
      return;
    }

    if (selectedType === 1){
      if (data.code){
        bubble(`Tu c√≥digo es: ${data.code}\n\nTienes 15 minutos para ingresarlo.`);
      } else {
        bubble("No encontr√© un c√≥digo v√°lido en tu correo m√°s reciente. Vuelve a solicitarlo desde la TV y luego intenta otra vez.","bot","bad");
      }
    } else if (selectedType === 2 || selectedType === 3){
      if (data.link){
        bubble(`Tu enlace es: ${data.link}\n\nTienes 15 minutos para ingresarlo.`);
      } else {
        bubble("No encontr√© ning√∫n enlace v√°lido en tu correo. Aseg√∫rate de haber elegido la opci√≥n en la TV y de que el correo ya haya llegado.","bot","bad");
      }
    }
    bubble('Escribe "hola" para volver al men√∫ principal.');
    input.placeholder = 'Escribe "hola" para reiniciar';
  }catch(err){
    bubble(`Error: ${err.message || err}`, "bot", "bad");
    bubble('Escribe "hola" para volver al men√∫ principal.');
    input.placeholder = 'Escribe "hola" para reiniciar';
  }
}

// Eventos
form.addEventListener('submit', (e)=>{ e.preventDefault(); onSend(); });
reset();
</script>
</body>
</html>
