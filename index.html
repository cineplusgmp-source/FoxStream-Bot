<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fox Stream Bot</title>
<style>
  :root{
    --bg:#f4f7fb; --card:#fff; --txt:#1f2937; --muted:#64748b;
    --accent:#1e40af; --accent-2:#2563eb; --ok:#16a34a; --err:#dc2626;
    --bubble:#eaf2ff; --bubble-me:#eef2f7;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  h1{font-size:32px;margin:0 0 4px}
  .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
  .board{background:var(--card);border-radius:16px;padding:16px 16px 90px;position:relative;min-height:60vh;box-shadow:0 8px 28px rgba(0,0,0,.06)}
  .msg{display:flex;gap:10px;margin:10px 0;align-items:flex-start}
  .msg .b{background:var(--bubble);padding:10px 12px;border-radius:10px;max-width:100%}
  .me .b{background:var(--bubble-me)}
  .ok{background:#e8f9ee;color:#065f46;border:1px solid #86efac}
  .err{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
  .hint{color:var(--muted);font-size:14px}
  .chip{display:inline-block;background:#eef2ff;color:#1e3a8a;border-radius:999px;padding:4px 10px;margin:6px 8px 0 0;border:1px solid #c7d2fe}
  .choices{padding:12px;border:1px dashed #c7d2fe;background:#f8fbff;border-radius:12px}
  .iptbar{position:absolute;left:0;right:0;bottom:0;padding:12px 16px;background:linear-gradient(to top,rgba(244,247,251,1),rgba(244,247,251,.85),transparent)}
  .iptbar .row{display:flex;gap:8px}
  input[type=text]{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:14px 12px;font-size:16px;outline:none}
  input[type=text]:focus{border-color:#9aa7ff;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  button{background:var(--accent-2);border:none;color:#fff;border-radius:10px;padding:0 20px;font-size:16px}
  button:disabled{opacity:.6}
  .small{font-size:12px;color:#6b7280;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Fox Stream Bot</h1>
    <div class="sub">Soporte automático 24/7<br><span id="ver" class="small"></span></div>

    <div class="board" id="board">
      <div class="msg">
        <div class="b">👋 ¡Hola! Escribe tu número de teléfono para validar tu acceso.</div>
      </div>
    </div>

    <div class="iptbar">
      <div class="row">
        <input id="ipt" type="text" placeholder='Escribe tu número de teléfono (solo dígitos) o "hola"' autocomplete="off" />
        <button id="btn">Enviar</button>
      </div>
      <div class="small">Tip: presiona Enter para enviar.</div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbyRNIE_eD0BkyyT8Kf3339SRllv2Ih6ywd7eUTFMHYpR5hx3p36fEp9XSLrQyEsGFAV/exec"; // tu nueva URL
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWOkT2EnwWDIEUipuh_CN603Qm9KGk_N1qJrzP7Hy7b-wRrr0De06fE_8WAeUaywhGs2psz8c_fVIj/pub?gid=0&single=true&output=csv";
const COUNTRY_PREFIX = ""; // ej. "51" si quieres forzar +51

/* ====== UI helpers ====== */
const board = document.getElementById('board');
const ipt   = document.getElementById('ipt');
const btn   = document.getElementById('btn');
const verEl = document.getElementById('ver');

function bubble(text, me=false, cls=""){
  const row = document.createElement('div');
  row.className = "msg" + (me ? " me" : "");
  const b = document.createElement('div');
  b.className = "b " + cls;
  b.textContent = text;
  row.appendChild(b);
  board.appendChild(row);
  board.scrollTo({top: board.scrollHeight, behavior:"smooth"});
}

function choices() {
  const wrap = document.createElement('div');
  wrap.className = 'msg';
  const box = document.createElement('div');
  box.className = 'b choices';
  box.innerHTML = `
    <div><strong>Selecciona una opción:</strong></div>
    <span class="chip">1) Código de acceso temporal</span>
    <span class="chip">2) Actualizar tu Hogar</span>
    <span class="chip">3) Nueva solicitud de inicio (TV)</span>
  `;
  wrap.appendChild(box);
  board.appendChild(wrap);
}

function setBusy(on){
  btn.disabled = on; ipt.disabled = on;
}

/* ====== Estado ====== */
let state = "askPhone"; // askPhone -> menu -> askEmail(type) -> calling -> done
let phone = "";
let clients = null;

/* ====== Utils ====== */
async function fetchCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  const txt = await res.text();
  const rows = txt.split(/\r?\n/).map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const head = rows.shift();
  const idxName = head.findIndex(h => /nombre/i.test(h));
  const idxPhone= head.findIndex(h => /tel(e|é)fono/i.test(h));
  return rows.map(r => ({name:r[idxName]?.trim()||"", phone:r[idxPhone]?.replace(/\D+/g,'')||""})).filter(x=>x.phone);
}

function normalizeNumber(raw){
  const digits = String(raw).replace(/\D+/g,'');
  if (!COUNTRY_PREFIX) return digits;
  // Si el cliente pone sin prefijo, lo agregamos para comparar
  if (digits.startsWith(COUNTRY_PREFIX)) return digits;
  return COUNTRY_PREFIX + digits;
}

async function checkRegistered(num){
  if (!clients) clients = await fetchCSV(SHEET_CSV);
  const numClean = normalizeNumber(num);
  // aceptamos coincidencia exacta, o si el sheet tiene prefijo y el cliente no
  return clients.some(c => c.phone.endsWith(numClean) || numClean.endsWith(c.phone));
}

async function apiCall(type, email){
  // timeout 12s y manejo de red
  const url = `${ENDPOINT}?type=${encodeURIComponent(type)}&email=${encodeURIComponent(email)}`;
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 12000);
  try{
    const res = await fetch(url, {signal:ctrl.signal, cache:'no-store'});
    clearTimeout(t);
    // Apps Script devuelve JSON plano, no hace falta headers raros
    const data = await res.json();
    return data;
  }catch(err){
    return { ok:false, message:"No se pudo conectar con el servidor. Verifica tu conexión e inténtalo de nuevo." };
  }
}

/* ====== Flujo ====== */
async function handleInput(val){
  const text = val.trim();

  if (text.toLowerCase() === "hola"){
    state = "askPhone"; phone = "";
    bubble('Escribe "hola" para volver al menú principal.', false, "hint");
    bubble('👋 ¡Hola! Escribe tu número de teléfono para validar tu acceso.');
    return;
  }

  if (state === "askPhone"){
    const onlyDigits = text.replace(/\D+/g,'');
    if (!onlyDigits){
      bubble("Por favor, ingresa solo dígitos del teléfono.", false, "err");
      return;
    }
    bubble(onlyDigits, true);
    setBusy(true);
    const ok = await checkRegistered(onlyDigits);
    setBusy(false);
    if (!ok){
      bubble("Tu número no está registrado. Por favor, contáctate con el administrador.", false, "err");
      bubble('Escribe "hola" para volver al menú principal.', false, "hint");
      return;
    }
    phone = onlyDigits;
    bubble("Número verificado. ¡Bienvenido!", false, "ok");
    choices();
    state = "menu";
    return;
  }

  if (state === "menu"){
    const opt = text.replace(/\D+/g,'');
    bubble(text, true);
    if (!["1","2","3"].includes(opt)){
      bubble("Respuesta inválida. Elige 1, 2 o 3.", false, "err");
      return;
    }
    state = `askEmail_${opt}`;
    bubble("Por favor, ingresa tu correo sin espacios:", false);
    return;
  }

  if (state.startsWith("askEmail_")){
    const type = state.split("_")[1];
    const email = text.trim().toLowerCase();
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
      bubble("Correo inválido. Inténtalo nuevamente.", false, "err");
      return;
    }
    bubble(email, true);
    bubble("⏳ Consultando tu correo...", false);
    setBusy(true);
    const r = await apiCall(type, email);
    setBusy(false);

    if (!r.ok){
      bubble(`Error: ${r.message}`, false, "err");
      bubble('Escribe "hola" para volver al menú principal.', false, "hint");
      state = "done";
      return;
    }

    if (r.kind === "code"){
      bubble(`Tu código es: ${r.code}\nTienes 15 minutos para ingresarlo.`, false, "ok");
    }else if (r.kind === "link"){
      bubble(`Tu enlace es: ${r.link}\nTienes 15 minutos para ingresarlo.`, false, "ok");
    }else{
      bubble("No se pudo interpretar la respuesta.", false, "err");
    }
    bubble('Escribe "hola" para volver al menú principal.', false, "hint");
    state = "done";
    return;
  }

  // Si está en done, cualquier otra entrada distinta a "hola"
  bubble('Escribe "hola" para volver al menú principal.', false, "hint");
}

/* ====== Eventos ====== */
btn.addEventListener('click', () => {
  const v = ipt.value;
  if (!v.trim()) return;
  ipt.value = "";
  handleInput(v);
});
ipt.addEventListener('keydown', (e) => {
  if (e.key === "Enter"){
    e.preventDefault();
    btn.click();
  }
});

/* ====== Mostrar versión backend en pantalla ====== */
(async () => {
  try{
    const r = await fetch(ENDPOINT + "?ping=1", {cache:'no-store'});
    const j = await r.json();
    if (j?.ok && j?.version){
      verEl.textContent = `frontend v0.8 · backend ${j.version}`;
    }else{
      verEl.textContent = "frontend v0.8 · backend (sin respuesta)";
    }
  }catch(_){
    verEl.textContent = "frontend v0.8 · backend (sin respuesta)";
  }
})();
</script>
</body>
</html>
